<html lang="en">  
</body>
</html>
<head>
  <title>A-EYE</title> <!-- web name -->
  <LInk rel="icon" href="./image/logos/logo-02.png" type="image/x-icon"> <!-- web icon -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>  <!-- onlin icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">  <!-- onlin icons -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css-files/body-html.css"> <!-- css file loc -->
  <link rel="stylesheet" href="./css-files/index-css/header.css"> <!-- css file loc -->
  <link rel="stylesheet" href="./css-files/login-css/login.css"> <!-- css file loc -->
  <script type="module" src="./js-filse/login-js/firebase-db.js"></script>
  <script type="module" src="./js-filse/login-js/loading.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pica/dist/pica.min.js"></script>
</head>
<body>
      <!-- header -->
      <div class="header" id="header">
        <div class="logo">
          <h5 class="header-logo-h5">AEYE</h5>
        </div>
        <div class="main-header">
          <a id="allglassesheader" href="index.html" class="aa">Home</a>
          <a id="loginheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#000';
            document.getElementById('createmain').style.display = 'none';

            document.getElementById('loginheader').style.color = '#790000';
            document.getElementById('loginmain').style.display = 'block';

            document.getElementById('forgetheader').style.color = '#000';
            document.getElementById('forgetmain').style.display = 'none';
          ">Login</a>
          <a id="createheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#790000';
            document.getElementById('createmain').style.display = 'block';
            
            document.getElementById('loginheader').style.color = '#000';
            document.getElementById('loginmain').style.display = 'none';
            
            document.getElementById('forgetheader').style.color = '#000';
            document.getElementById('forgetmain').style.display = 'none';
          ">Sigin up</a>
          <a id="forgetheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#000';
            document.getElementById('createmain').style.display = 'none';
            
            document.getElementById('loginheader').style.color = '#000';
            document.getElementById('loginmain').style.display = 'none';
            
            document.getElementById('forgetheader').style.color = '#790000';
            document.getElementById('forgetmain').style.display = 'block';
          ">Forget</a>
        </div>
        <div class="login-button-home">
          <div class="bage-center" onclick="window.location.href = './checkout.html';" style="margin-right: 10;">
            <img src="./image/icons/bag.png" alt="" class="header-cart" onclick="">
            <p class="quantity" id="cart-count">2</p>
          </div>
          <a href="orders.html">
            <img src="./image/icons/delivery-truck.png" alt="" class="img-header-login" style="width: 30px; height: 30px; margin-left: -10px;" loading="lazy">
          </a>
          <a href="login.html" id="adduser">
            <img src="./image/icons/add-user.png" alt="" class="img-header-login">
            </a>
            <a href="account.html" id="user" style="display: none;">
              <img src="./image/icons/user.png" alt="" class="img-header-login">
            </a>
            <script>
              if (localStorage.getItem('loginmethod') === '555') {
                document.getElementById('adduser').style.display = 'none';
                document.getElementById('user').style.display = 'block';
              }
            </script>
        </div>
      </div>
      <!-- header -->

      <!-- create -->
       <div class="create" id="createmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Sign Up Your Account</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Name</p>
                <div class="input-div-style">
                  <input id="nameAcc" type="text" class="input-style">
                  <img src="./image/singin/user.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="gmailAcc" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Password</p>
                <div class="input-div-style">
                  <input id="passAcc" type="text" class="input-style">
                  <img src="./image/singin/key.png" alt="" class="input-img">
                </div>
              </div>
              <p id="erorrMasge" style="text-align: left; margin-bottom: 0px; margin-left: 10px; width: 50%;">Please fill in all fields</p>
              <button class="login-button" onclick="
                var name = document.getElementById('nameAcc').value;
                var email = document.getElementById('gmailAcc').value;
                var password = document.getElementById('passAcc').value;
                var isValid = true;

                // Validate name
                if (name.length > 15) {
                    document.getElementById('nameAcc').style.border = 'red 1px solid';
                    document.getElementById('erorrMasge').innerText = 'Your Name is long Please write at most 14 characters.';
                    document.getElementById('erorrMasge').style.color = 'red';
                    isValid = false;
                } else {
                  document.getElementById('nameAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is good';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (name.length < 3) {
                  document.getElementById('nameAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is short Please write at least 4 characters.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('nameAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is good';
                  document.getElementById('erorrMasge').style.color = 'green';
                }

                // Validate email
                if (!email.endsWith('@gmail.com')) {
                  document.getElementById('gmailAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Email most ending with @gmail.com';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('gmailAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (email.length < 13) {
                  document.getElementById('gmailAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Email is short Please write 13 at all.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('gmailAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }

                // Validate password
                if (password.length < 8) {
                  document.getElementById('passAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your password is short Please write at least 8 characters.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('passAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (isValid) {
                  localStorage.setItem('nameSignup', name);
                  localStorage.setItem('emailSignup', email);
                  localStorage.setItem('passSignup', password);
                  document.getElementById('part1sinup').style.display = 'none';
                  document.getElementById('part2sinup').style.display = 'block';
                  document.getElementById('part3sinup').style.display = 'none';
                }
              ">Continue</button>
            </div>

            <div class="part2" id="part2sinup">
              <div class="phone1" style="display: flex; flex-direction: column;">
                <h2 style="margin-top: -20px;">Glasses Prescription</h2>
                <div style="display: flex; align-items: center; margin-top: -10px; margin-bottom: 5px;">
                  <label for="imageUpload" class="upload-btn">Upload Img</label>
                  <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                  <button class="upload-btn" onclick="openCamera('capture')">Capture</button>
                  <button class="upload-btn" onclick="startAutoScan()">Auto Scan</button>
                </div>
                <p id="loading" style="margin-left: 20px; display: none;">Processing image... <span id="progressPercent">0</span>%</p>
              </div>
              <p id="output" class="phone2" style="font-size: 90%;">Extracted text will appear here</p>
            
              <div class="eyeline-1">
                <div class="eyeblock1"><h4 class="aeyeText">AEYE</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Sphere</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Cylinder</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Axis</h4></div>
              </div>
              <div class="eyeline-2">
                <div class="eyeblock1"><h4 class="aeyeText">Right (OD)</h4></div>
                <div class="eyeblock3"><input id="odSp" type="text" class="inputeyefildes" placeholder="+2.50"></div>
                <div class="eyeblock3"><input id="odCy" type="text" class="inputeyefildes" placeholder="-1.50"></div>
                <div class="eyeblock3"><input id="odAx" type="text" class="inputeyefildes" placeholder="70"></div>
              </div>
              <div class="eyeline-3">
                <div class="eyeblock1"><h4 class="aeyeText">Left (OS)</h4></div>
                <div class="eyeblock3"><input id="osSp" type="text" class="inputeyefildes" placeholder="-2.50"></div>
                <div class="eyeblock3"><input id="osCy" type="text" class="inputeyefildes" placeholder="+3.50"></div>
                <div class="eyeblock3"><input id="osAx" type="text" class="inputeyefildes" placeholder="80"></div>
              </div>
              <progress id="progressBar" value="0" max="100" style="margin-left: 15%; width: 70%; margin-top: 0;"></progress>
              <p id="errorMessage" style="text-align: left; margin-bottom: 5px; margin-left: 17%; width: 70%; color: red; margin-top: 5px;">Please fill in all fields, and if you wanna skip, add all 0</p>
              <button id="ssssssssssssssss3" class="sssggssddss login-button widthbut" onclick="
              validateAndContinue();
              function validateAndContinue() {
                  // Define all prescription fields with their IDs and whether they're axis fields
                  const fields = [
                      { id: 'odSp', isAxis: false },  // Right Eye Sphere
                      { id: 'odCy', isAxis: false },  // Right Eye Cylinder
                      { id: 'odAx', isAxis: true },   // Right Eye Axis
                      { id: 'osSp', isAxis: false },  // Left Eye Sphere
                      { id: 'osCy', isAxis: false },  // Left Eye Cylinder
                      { id: 'osAx', isAxis: true }    // Left Eye Axis
                  ];
                  
                  let isValid = true;      // Flag to track if all fields are valid
                  let allEmpty = true;     // Flag to track if all fields are empty
                  
                  // Validate each field
                  fields.forEach(({ id, isAxis }) => {
                      const el = document.getElementById(id);
                      const value = el.value.trim();
                      
                      if (value === '') {
                          // Field is empty - mark as invalid
                          el.style.border = '1px solid red';
                          isValid = false;
                      } else if (!isValidPrescriptionValue(value, isAxis)) {
                          // Field has invalid value - mark as invalid
                          el.style.border = '1px solid red';
                          isValid = false;
                          allEmpty = false;  // At least one field has content
                      } else {
                          // Field is valid
                          el.style.border = '1px solid green';
                          allEmpty = false;  // At least one field has content
                      }
                  });
                  
                  const btn = document.getElementById('ssssssssssssssss3');
                  const errorEl = document.getElementById('errorMessage');
                  
                  if (!isValid && allEmpty) {
                      // CASE 1: All fields are empty - show Skip option
                      btn.textContent = 'Skip (Set to 0)';
                      errorEl.textContent = 'All fields are empty. Click to set all to 0.';
                      errorEl.style.color = 'red';
                      
                      // Change button action to set all fields to 0
                      btn.onclick = function() {
                          fields.forEach(({ id }) => {
                              document.getElementById(id).value = '0';
                              document.getElementById(id).style.border = '1px solid green';
                          });
                          
                          // Reset button to original state
                          btn.textContent = 'Continue';
                          errorEl.textContent = '';
                          
                          // Restore original button function
                          btn.onclick = function() {
                              validateAndContinue();
                          };
                      };
                  } else if (!isValid) {
                      // CASE 2: Some fields have invalid values (but not all empty) - show error
                      btn.textContent = 'Continue';
                      errorEl.textContent = 'Invalid values detected. Please correct them.';
                      errorEl.style.color = 'red';
                      
                      // Keep original validation behavior
                      btn.onclick = function() {
                          validateAndContinue();
                      };
                  } else {
                      // CASE 3: All fields are valid - proceed
                      btn.textContent = 'Continue';
                      errorEl.textContent = '';
                      
                      // Save values to localStorage
                      localStorage.setItem('odSp', document.getElementById('odSp').value);
                      localStorage.setItem('odCy', document.getElementById('odCy').value);
                      localStorage.setItem('odAx', document.getElementById('odAx').value);
                      localStorage.setItem('osSp', document.getElementById('osSp').value);
                      localStorage.setItem('osCy', document.getElementById('osCy').value);
                      localStorage.setItem('osAx', document.getElementById('osAx').value);
                      
                      // Move to next section
                      document.getElementById('part1sinup').style.display = 'none';
                      document.getElementById('part2sinup').style.display = 'none';
                      document.getElementById('part3sinup').style.display = 'block';
                  }
              }
          
              // Function to validate prescription values
              function isValidPrescriptionValue(value, isAxis) {
                  if (value === '0') return true;
                  
                  if (isAxis) {
                      // Axis values must be integers between 0-180
                      const num = parseInt(value);
                      return !isNaN(num) && num >= 0 && num <= 180;
                  } else {
                      // Sphere/Cylinder values must be decimals between -30 and +30 with max 2 decimal places
                      const num = parseFloat(value);
                      return !isNaN(num) && num >= -30 && num <= 30 && 
                            /^[+-]?\d+(\.\d{1,2})?$/.test(value);
                  }
              }
            ">Continue</button>
            </div>
            
            <!-- Camera Modal -->
            <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center;">
              <div style="width: 90%; max-width: 500px; background: white; padding: 20px; border-radius: 10px;">
                <h2 id="modalTitle">Capture Prescription</h2>
                
                <!-- Camera Selection and Info -->
                <div id="cameraControls" style="margin-bottom: 10px;">
                  <div id="cameraInfo" style="padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px; display: none;">
                    <h4 style="margin-top: 0;">Available Cameras:</h4>
                    <div id="camerasList" style="max-height: 100px; overflow-y: auto;"></div>
                  </div>
                  
                  <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <button id="switchCameraBtn" class="camera-control-btn" style="display: none;">
                      <i class="fas fa-sync-alt"></i> Switch Camera
                    </button>
                    <button id="flashBtn" class="camera-control-btn" style="display: none;">
                      <i class="fas fa-bolt"></i> Flash OFF
                    </button>
                  </div>
                </div>
                
                <!-- Error Message Display -->
                <div id="cameraError" style="color: red; margin: 10px 0; display: none;"></div>
                
                <!-- Camera Feed -->
                <video id="cameraFeed" autoplay playsinline style="width: 100%; height: auto; background: black;"></video>
                <canvas id="photoCanvas" style="display: none;"></canvas>
                
                <!-- Action Buttons -->
                <div style="display: flex; justify-content: center; margin-top: 15px; gap: 10px;">
                  <button id="captureBtn" class="action-btn" style="background: #4CAF50; display: none;">
                    <i class="fas fa-camera"></i> Capture
                  </button>
                  <button onclick="closeCamera()" class="action-btn" style="background: #f44336;">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </div>
              </div>
            </div>

            <!-- Add Font Awesome for icons -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

            
            <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
            <script>
            // Add this CSS to your stylesheet or in a <style> tag
            const cameraModalStyles = `
            <style>
              /* Improved Camera Modal Styling */
              #cameraModal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 1000;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
              }

              #cameraModal .modal-container {
                width: 95%;
                max-width: 500px;
                background: white;
                border-radius: 10px;
                padding: 15px;
                box-sizing: border-box;
                margin: 20px 0;
                display: flex;
                flex-direction: column;
                max-height: 90vh;
              }

              #cameraModal .modal-header {
                margin-bottom: 10px;
              }

              #cameraModal .modal-body {
                flex: 1;
                overflow: auto;
                margin-bottom: 10px;
              }

              #cameraModal .modal-footer {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
                padding-top: 10px;
                position: sticky;
                bottom: 0;
                background: white;
                z-index: 10;
              }

              #cameraFeed {
                width: 100%;
                height: auto;
                max-height: 60vh;
                background: black;
                border-radius: 5px;
              }

              .camera-control-btn {
                padding: 10px 15px;
                background: #2196F3;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 5px;
              }

              .action-btn {
                padding: 12px 20px;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                flex: 1;
                min-width: 120px;
              }

              #captureBtn {
                background: #4CAF50;
              }

              #cancelCameraBtn {
                background: #f44336;
              }

              #switchCameraBtn {
                background: #2196F3;
              }

              #flashBtn {
                background: #FF9800;
              }

              #cameraInfo {
                margin-bottom: 10px;
                padding: 10px;
                background: #f5f5f5;
                border-radius: 5px;
              }

              #camerasList {
                max-height: 120px;
                overflow-y: auto;
                margin-top: 8px;
              }

              .camera-option-btn {
                display: block;
                width: 100%;
                padding: 8px 12px;
                margin: 5px 0;
                text-align: left;
                background: #f1f1f1;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.3s;
                font-size: 14px;
              }

              .camera-option-btn:hover {
                background: #ddd;
              }

              #cameraError {
                padding: 10px;
                background: #ffebee;
                border-left: 4px solid #f44336;
                margin: 10px 0;
                display: none;
              }

              @media (max-width: 480px) {
                #cameraModal .modal-container {
                  width: 100%;
                  height: 100%;
                  max-height: 100%;
                  border-radius: 0;
                  margin: 0;
                }

                #cameraFeed {
                  max-height: 50vh;
                }

                .action-btn {
                  padding: 10px 15px;
                  font-size: 14px;
                }
              }
            </style>
            `;

            // Add the styles to the document head
            document.head.insertAdjacentHTML('beforeend', cameraModalStyles);

            // Modified camera modal HTML structure
            const cameraModalHTML = `
            <div id="cameraModal">
              <div class="modal-container">
                <div class="modal-header">
                  <h2 id="modalTitle">Capture Prescription</h2>
                </div>
                
                <div class="modal-body">
                  <div id="cameraInfo" style="display: none;">
                    <h4 style="margin-top: 0;">Available Cameras:</h4>
                    <div id="camerasList"></div>
                  </div>
                  
                  <div id="cameraError"></div>
                  
                  <video id="cameraFeed" autoplay playsinline></video>
                  <canvas id="photoCanvas" style="display: none;"></canvas>
                  
                  <div style="display: flex; gap: 8px; margin: 10px 0; justify-content: center;">
                    <button id="switchCameraBtn" class="camera-control-btn">
                      <i class="fas fa-sync-alt"></i> Switch
                    </button>
                    <button id="flashBtn" class="camera-control-btn">
                      <i class="fas fa-bolt"></i> Flash
                    </button>
                  </div>
                </div>
                
                <div class="modal-footer">
                  <button id="captureBtn" class="action-btn">
                    <i class="fas fa-camera"></i> Capture
                  </button>
                  <button id="cancelCameraBtn" class="action-btn">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </div>
              </div>
            </div>
            `;

            // Add the modal to the document body
            document.body.insertAdjacentHTML('beforeend', cameraModalHTML);

            // Update the openCamera function to use the new modal
            async function openCamera(mode) {
                currentMode = mode;
                isAutoScan = mode === 'scan';
                document.getElementById('modalTitle').textContent = 
                    mode === 'scan' ? 'Auto Scanning Prescription' : 'Capture Prescription';
                
                // Show modal
                const modal = document.getElementById('cameraModal');
                modal.style.display = 'flex';
                
                // Lock body scroll when modal is open
                document.body.style.overflow = 'hidden';

                // Get available cameras
                if (!await getAvailableCameras()) {
                    showCameraError('No cameras available');
                    return;
                }

                // Start default camera
                if (!await startCamera()) return;

                // Setup UI based on mode
                document.getElementById('captureBtn').style.display = isAutoScan ? 'none' : 'flex';
                if (isAutoScan) {
                    autoScanTimeout = setTimeout(captureImage, 3000);
                }

                // Setup control buttons
                document.getElementById('switchCameraBtn').onclick = switchCamera;
                document.getElementById('flashBtn').onclick = toggleFlash;
                document.getElementById('captureBtn').onclick = captureImage;
                document.getElementById('cancelCameraBtn').onclick = closeCamera;
            }

            // Update closeCamera function to restore scroll
            function closeCamera() {
                if (autoScanTimeout) clearTimeout(autoScanTimeout);
                closeCurrentStream();
                
                const modal = document.getElementById('cameraModal');
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }

            // All other functions remain the same as in the previous complete code
            // (getAvailableCameras, startCamera, selectCamera, switchCamera, 
            // toggleFlash, captureImage, etc.)

            // =============================================
            // GLOBAL VARIABLES
            // =============================================
            let stream = null;
            let isAutoScan = false;
            let autoScanTimeout = null;
            let currentMode = '';
            let flashEnabled = false;
            let currentCameraId = '';
            let cameras = [];
            let facingMode = 'environment'; // Default to rear camera

            // =============================================
            // INITIALIZATION
            // =============================================
            window.addEventListener('DOMContentLoaded', () => {
                // Load saved prescription values
                const fields = ['odSp', 'odCy', 'odAx', 'osSp', 'osCy', 'osAx'];
                fields.forEach(field => {
                    const savedValue = localStorage.getItem(field);
                    if (savedValue) document.getElementById(field).value = savedValue;
                });
                
                // Check camera support
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.error('Camera API not supported');
                }
            });

            // =============================================
            // CAMERA FUNCTIONS
            // =============================================

            // Main function to open camera
            async function openCamera(mode) {
                currentMode = mode;
                isAutoScan = mode === 'scan';
                document.getElementById('modalTitle').textContent = 
                    mode === 'scan' ? 'Auto Scanning Prescription' : 'Capture Prescription';
                document.getElementById('cameraModal').style.display = 'flex';

                // Get available cameras
                if (!await getAvailableCameras()) {
                    showCameraError('No cameras available');
                    return;
                }

                // Start default camera
                if (!await startCamera()) return;

                // Setup UI based on mode
                document.getElementById('captureBtn').style.display = isAutoScan ? 'none' : 'inline-block';
                if (isAutoScan) {
                    autoScanTimeout = setTimeout(captureImage, 3000);
                }

                // Setup control buttons
                document.getElementById('switchCameraBtn').onclick = switchCamera;
                document.getElementById('flashBtn').onclick = toggleFlash;
                document.getElementById('captureBtn').onclick = captureImage;
            }

            // Get list of available cameras
            async function getAvailableCameras() {
                try {
                    // First get permission
                    const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    tempStream.getTracks().forEach(track => track.stop());

                    // Enumerate devices
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    cameras = devices.filter(device => device.kind === 'videoinput');
                    
                    // Update UI
                    const camerasList = document.getElementById('camerasList');
                    camerasList.innerHTML = cameras.length ? '' : '<p>No cameras found</p>';
                    
                    cameras.forEach((camera, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'camera-option-btn';
                        btn.innerHTML = `
                            <i class="fas fa-camera"></i> 
                            ${camera.label || `Camera ${index+1}`}
                            ${camera.label?.toLowerCase().includes('back') ? ' (Rear)' : ''}
                            ${camera.label?.toLowerCase().includes('front') ? ' (Front)' : ''}
                        `;
                        btn.onclick = () => selectCamera(camera.deviceId);
                        camerasList.appendChild(btn);
                    });

                    document.getElementById('cameraInfo').style.display = 'block';
                    return true;
                } catch (err) {
                    console.error('Camera enumeration error:', err);
                    showCameraError('Cannot access cameras. Please allow permissions.');
                    return false;
                }
            }

            // Start specific camera
            async function startCamera(deviceId = null) {
                closeCurrentStream();
                hideCameraError();

                try {
                    // Try preferred constraints first
                    const constraints = {
                        video: {
                            ...(deviceId ? { deviceId: { exact: deviceId } } : { facingMode }),
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };

                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    document.getElementById('cameraFeed').srcObject = stream;

                    // Store current camera ID
                    const videoTrack = stream.getVideoTracks()[0];
                    if (videoTrack) {
                        currentCameraId = videoTrack.getSettings().deviceId;
                        console.log('Active camera:', videoTrack.label);
                    }

                    updateCameraControls();
                    return true;
                } catch (err) {
                    console.error('Camera start error:', err);
                    
                    // Friendly error messages
                    const errors = {
                        NotAllowedError: 'Please allow camera access in browser settings',
                        NotFoundError: 'No camera found on this device',
                        OverconstrainedError: 'Camera configuration not supported',
                        NotReadableError: 'Camera is in use by another application'
                    };
                    
                    showCameraError(errors[err.name] || 'Could not access camera');
                    return false;
                }
            }

            // Select specific camera
            async function selectCamera(deviceId) {
                try {
                    await startCamera(deviceId);
                    // Highlight selected camera button
                    document.querySelectorAll('.camera-option-btn').forEach(btn => {
                        btn.style.background = btn.textContent.includes(deviceId) ? '#4CAF50' : '';
                    });
                } catch (err) {
                    console.error('Camera selection error:', err);
                    showCameraError('Failed to switch cameras');
                }
            }

            // Switch between front/back cameras
            async function switchCamera() {
                if (cameras.length < 2) {
                    showCameraError('Only one camera available');
                    return;
                }

                facingMode = facingMode === 'user' ? 'environment' : 'user';
                await startCamera(); // Restart with new facing mode
            }

            // Toggle flash
            async function toggleFlash() {
                if (!stream) return;

                try {
                    const videoTrack = stream.getVideoTracks()[0];
                    if (!videoTrack?.getCapabilities().torch) {
                        showCameraError('Flash not available');
                        return;
                    }

                    flashEnabled = !flashEnabled;
                    await videoTrack.applyConstraints({ advanced: [{ torch: flashEnabled }] });
                    
                    const flashBtn = document.getElementById('flashBtn');
                    flashBtn.innerHTML = flashEnabled 
                        ? '<i class="fas fa-bolt"></i> Flash ON' 
                        : '<i class="fas fa-bolt"></i> Flash OFF';
                } catch (err) {
                    console.error('Flash error:', err);
                    showCameraError('Failed to toggle flash');
                }
            }

            // Update camera controls visibility
            function updateCameraControls() {
                if (!stream) return;
                
                const videoTrack = stream.getVideoTracks()[0];
                if (!videoTrack) return;

                document.getElementById('switchCameraBtn').style.display = 
                    cameras.length > 1 ? 'inline-block' : 'none';
                
                document.getElementById('flashBtn').style.display = 
                    videoTrack.getCapabilities().torch ? 'inline-block' : 'none';
            }

            // Close camera
            function closeCamera() {
                if (autoScanTimeout) clearTimeout(autoScanTimeout);
                closeCurrentStream();
                document.getElementById('cameraModal').style.display = 'none';
            }

            function closeCurrentStream() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }

            // =============================================
            // IMAGE CAPTURE & PROCESSING
            // =============================================

            function captureImage() {
                const video = document.getElementById('cameraFeed');
                const canvas = document.getElementById('photoCanvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                closeCamera();
                processCapturedImage(canvas.toDataURL('image/jpeg'));
            }

            async function processCapturedImage(imageData) {
                try {
                    // Show loading state
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('progressBar').value = 0;
                    document.getElementById('output').textContent = 'Processing image...';

                    // Enhance image
                    const processedImage = await enhanceImage(imageData);
                    
                    // Perform OCR
                    const text = await performOCR(processedImage);
                    document.getElementById('output').textContent = text;
                    
                    // Parse prescription
                    parsePrescription(text);
                } catch (err) {
                    console.error('Image processing error:', err);
                    document.getElementById('output').textContent = 'Error processing image';
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }

            async function enhanceImage(imageData) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize maintaining aspect ratio
                        const maxSize = 1000;
                        let width = img.width, height = img.height;
                        if (width > maxSize) {
                            height = (maxSize / width) * height;
                            width = maxSize;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Apply contrast enhancement
                        const imageData = ctx.getImageData(0, 0, width, height);
                        const data = imageData.data;
                        const contrast = 1.5;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            const gray = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
                            const adjusted = (gray - 128) * contrast + 128;
                            data[i] = data[i+1] = data[i+2] = Math.max(0, Math.min(255, adjusted));
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg'));
                    };
                    img.src = imageData;
                });
            }

            // =============================================
            // OCR PROCESSING
            // =============================================

            async function performOCR(imageData) {
                const { data: { text } } = await Tesseract.recognize(imageData, 'eng', {
                    logger: progress => {
                        document.getElementById('progressBar').value = progress.progress * 100;
                        if (progress.status) {
                            document.getElementById('output').textContent = progress.status;
                        }
                    },
                    tessedit_char_whitelist: '0123456789+-.ODOSRLEAXISPHCYLAXSPHEREYRIGHTLEFT',
                    preserve_interword_spaces: '1'
                });
                return text;
            }

            function parsePrescription(text) {
                // Normalize text
                const normalized = text
                    .replace(/[^a-zA-Z0-9\+\-\.\s]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .toUpperCase();

                // Try different pattern matches
                const patterns = [
                    /(?:OD|RIGHT|RE)[^:\n]*:\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+).*?(?:OS|LEFT|LE)[^:\n]*:\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+)/i,
                    /(?:SPH|SPHERE)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:CYL|CYLINDER)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:AX|AXIS)[^\d\+-]*(\d+).*?(?:SPH|SPHERE)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:CYL|CYLINDER)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:AX|AXIS)[^\d\+-]*(\d+)/i,
                    /([+-]?\d+\.?\d*)\s+([+-]?\d+\.?\d*)\s+(\d+)\s+([+-]?\d+\.?\d*)\s+([+-]?\d+\.?\d*)\s+(\d+)/i
                ];

                let matches;
                for (const pattern of patterns) {
                    matches = normalized.match(pattern);
                    if (matches) break;
                }

                // Apply matched values or fallback
                if (matches && matches.length >= 7) {
                    const isOdFirst = normalized.includes('OD') || normalized.includes('RIGHT');
                    const values = isOdFirst ? 
                        [matches[1], matches[2], matches[3], matches[4], matches[5], matches[6]] :
                        [matches[4], matches[5], matches[6], matches[1], matches[2], matches[3]];
                    
                    ['odSp', 'odCy', 'odAx', 'osSp', 'osCy', 'osAx'].forEach((field, i) => {
                        document.getElementById(field).value = formatNumber(values[i], field.includes('Ax'));
                    });
                } else {
                    // Fallback to extracting all numbers
                    const numbers = normalized.match(/[+-]?\d+\.?\d*/g) || [];
                    if (numbers.length >= 6) {
                        ['odSp', 'odCy', 'odAx', 'osSp', 'osCy', 'osAx'].forEach((field, i) => {
                            document.getElementById(field).value = formatNumber(numbers[i], field.includes('Ax'));
                        });
                    } else {
                        alert("Couldn't extract prescription. Please enter manually.");
                    }
                }
            }

            function formatNumber(value, isAxis = false) {
                if (!value) return '0';
                
                let numStr = value.toString().replace(/[^0-9+-.]/g, '');
                
                if (isAxis) {
                    const axisNum = Math.max(0, Math.min(180, parseInt(numStr)));
                    return axisNum.toString();
                }
                
                if (!['+', '-'].includes(numStr.charAt(0))) {
                    numStr = '+' + numStr;
                }
                
                if (!numStr.includes('.')) {
                    numStr += '.00';
                } else {
                    const parts = numStr.split('.');
                    numStr = parts[0] + '.' + parts[1].padEnd(2, '0').substring(0, 2);
                }
                
                return numStr;
            }

            // =============================================
            // UTILITY FUNCTIONS
            // =============================================

            function showCameraError(message) {
                const el = document.getElementById('cameraError');
                el.textContent = message;
                el.style.display = 'block';
            }

            function hideCameraError() {
                document.getElementById('cameraError').style.display = 'none';
            }

            function handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = e => processCapturedImage(e.target.result);
                reader.readAsDataURL(file);
            }

            function startAutoScan() {
                openCamera('scan');
            }

            </script>


            <div class="part3" id="part3sinup">
              <div class="input-laple editess">
                <p class="inp-text">Phone</p>
                <div class="input-div-style">
                  <input id="phoneAccc" type="text" class="input-style" placeholder="01120726090">
                  <img src="./image/singin/phone-receiver-silhouette.png" alt="" class="input-img">
                </div>
              </div>
              <div class="input-laple editess">
                <p class="inp-text">Address</p>
                <div class="input-div-style">
                  <textarea style="height: 100px; padding-right: 40px;" id="addressAccc" type="text" class="input-style" placeholder="Cairo-Badr - Downtown mall - Building 5 - Apartment 2"></textarea>
                  <img style="margin-top: 40px;" src="./image/singin/task-list.png" alt="" class="input-img">
                </div>
              </div>
              <p id="errorMessage2" style="margin-top: 80px; text-align: left; margin-bottom: 0px; margin-left: 26%; width: 50%;">Please fill in all fields</p>
              <button id="conbu" class="login-button widthbut" onclick="createACC()">Continue</button>
              <button id="createAcc" class="login-button widthbut" style="display: none;">Confirm Your Account</button>
              <script>
                  function createACC() {
                    var phone = document.getElementById('phoneAccc').value;
                    var address = document.getElementById('addressAccc').value;
                    var isValid = true;

                    // Validate phone
                    var phoneRegex = /^(011|012|015|010)\d{8}$/;
                    if (!phoneRegex.test(phone)) {
                        document.getElementById('phoneAccc').style.border = 'red 1px solid';
                        document.getElementById('errorMessage2').innerText = 'Your Phone is short Please write 11 characters. and It starts with 011, 012, 010, 015';
                        document.getElementById('errorMessage2').style.color = 'red';
                        isValid = false;
                    } else {
                      document.getElementById('phoneAccc').style.border = 'green 1px solid';
                      document.getElementById('errorMessage2').innerText = 'Your Name is good';
                      document.getElementById('errorMessage2').style.color = 'green';
                    }

                    // Validate address
                    if (address.length < 6) {
                        document.getElementById('addressAccc').style.border = 'red 1px solid';
                        document.getElementById('errorMessage2').innerText = 'Your Location is short Please write at least 6 characters.';
                        document.getElementById('errorMessage2').style.color = 'red';
                        isValid = false;
                    } else {
                      document.getElementById('addressAccc').style.border = 'green 1px solid';
                      document.getElementById('errorMessage2').innerText = 'Your Name is good';
                      document.getElementById('errorMessage2').style.color = 'green';
                    }

                    
                    if (isValid) {
                      localStorage.setItem('phoneSignup', phone);
                      localStorage.setItem('addressSignup', address);
                      document.getElementById('conbu').style.display = 'none';
                      document.getElementById('createAcc').style.display = 'block';
                    }
                  }
              </script>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      <!-- create -->

      <!-- login -->
      <div class="login" id="loginmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Login Your Account</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="loginemail" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Password</p>
                <div class="input-div-style">
                  <input id="loginpass" type="text" class="input-style">
                  <img src="./image/singin/key.png" alt="" class="input-img">
                </div>
              </div>
              <div class="remmber-div">
                <div class="forgetpass-div">
                  <a href="./forget.html" class="forget-h5 forget-h6">Forget Password</a>
                </div>
                <div class="remm-div">
                  <input type="checkbox" id="remember-me" style="margin-top: 14px;">
                  <h5 class="forget-h5" style="color: black; margin-top: 10px;" onclick="">Auto Remmber</h5>
                </div>
              </div>
              <button id="loginButton" class="login-button">Login</button>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      </div>
      <!-- login -->

      <!-- forget -->
      <div class="forget" id="forgetmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Forget Your Account Password</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="forgetemail" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
              <button id="forgetButton" class="login-button">Send Mail</button>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      </div>
      <!-- forget -->



      <div class="noneee" style="display: none;">
        <!-- login -->
       <div class="login">
        <h1>Login Page</h1>
        <form id="loginForm">
          <input type="email" id="email1" placeholder="Enter your email" required><br>
          <input type="password" id="password1" placeholder="Enter your password" required><br>
          <button type="button" id="">Login</button>
        </form>
        <h2>Stored Data:</h2>
        <div id="displayData"></div>
       </div>     
      <!-- login -->

      <!-- signup -->
      <h1>Sign Up</h1>
      <form id="signUpForm">
        <input type="text" id="name" placeholder="Enter your name" required><br>
        <input type="email" id="email" placeholder="Enter your email" required><br>
        <input type="password" id="password" placeholder="Enter your password" required><br>
        <input type="text" id="eyesight" placeholder="Enter your eyesight measurement" required><br>
        <input type="tel" id="phone" placeholder="Enter your phone number" required><br>
        <input type="text" id="address" placeholder="Enter your address" required><br>
        <button type="button" id="submitButton">Sign Up</button>
      </form>
      <!-- signup -->

      

      <h2>Forgot Password?</h2>
      <form id="forgotPasswordForm">
        <input type="email" id="forgotEmail" placeholder="Enter your email" required><br>
        <button type="button" id="resetPasswordButton">Send Password Reset Email</button>
      </form>
      </div>
</body>
</html>