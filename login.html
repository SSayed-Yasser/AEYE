<html lang="en">  
</body>
</html>
<head>
  <title>A-EYE</title> <!-- web name -->
  <LInk rel="icon" href="./image/logos/logo-02.png" type="image/x-icon"> <!-- web icon -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>  <!-- onlin icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">  <!-- onlin icons -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css-files/body-html.css"> <!-- css file loc -->
  <link rel="stylesheet" href="./css-files/index-css/header.css"> <!-- css file loc -->
  <link rel="stylesheet" href="./css-files/login-css/login.css"> <!-- css file loc -->
  <script type="module" src="./js-filse/login-js/firebase-db.js"></script>
  <script type="module" src="./js-filse/login-js/loading.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pica/dist/pica.min.js"></script>
</head>
<body>
      <!-- header -->
      <div class="header" id="header">
        <div class="logo">
          <h5 class="header-logo-h5">AEYE</h5>
        </div>
        <div class="main-header">
          <a id="allglassesheader" href="index.html" class="aa">Home</a>
          <a id="loginheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#000';
            document.getElementById('createmain').style.display = 'none';

            document.getElementById('loginheader').style.color = '#790000';
            document.getElementById('loginmain').style.display = 'block';

            document.getElementById('forgetheader').style.color = '#000';
            document.getElementById('forgetmain').style.display = 'none';
          ">Login</a>
          <a id="createheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#790000';
            document.getElementById('createmain').style.display = 'block';
            
            document.getElementById('loginheader').style.color = '#000';
            document.getElementById('loginmain').style.display = 'none';
            
            document.getElementById('forgetheader').style.color = '#000';
            document.getElementById('forgetmain').style.display = 'none';
          ">Sigin up</a>
          <a id="forgetheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#000';
            document.getElementById('createmain').style.display = 'none';
            
            document.getElementById('loginheader').style.color = '#000';
            document.getElementById('loginmain').style.display = 'none';
            
            document.getElementById('forgetheader').style.color = '#790000';
            document.getElementById('forgetmain').style.display = 'block';
          ">Forget</a>
        </div>
        <div class="login-button-home">
          <div class="bage-center" onclick="window.location.href = './checkout.html';" style="margin-right: 10;">
            <img src="./image/icons/bag.png" alt="" class="header-cart" onclick="">
            <p class="quantity" id="cart-count">2</p>
          </div>
          <a href="orders.html">
            <img src="./image/icons/delivery-truck.png" alt="" class="img-header-login">
          </a>
          <a href="login.html" id="adduser">
            <img src="./image/icons/add-user.png" alt="" class="img-header-login">
            </a>
            <a href="account.html" id="user" style="display: none;">
              <img src="./image/icons/user.png" alt="" class="img-header-login">
            </a>
            <script>
              if (localStorage.getItem('loginmethod') === '555') {
                document.getElementById('adduser').style.display = 'none';
                document.getElementById('user').style.display = 'block';
              }
            </script>
        </div>
      </div>
      <!-- header -->

      <!-- create -->
       <div class="create" id="createmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Sign Up Your Account</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Name</p>
                <div class="input-div-style">
                  <input id="nameAcc" type="text" class="input-style">
                  <img src="./image/singin/user.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="gmailAcc" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Password</p>
                <div class="input-div-style">
                  <input id="passAcc" type="text" class="input-style">
                  <img src="./image/singin/key.png" alt="" class="input-img">
                </div>
              </div>
              <p id="erorrMasge" style="text-align: left; margin-bottom: 0px; margin-left: 10px; width: 50%;">Please fill in all fields</p>
              <button class="login-button" onclick="
                var name = document.getElementById('nameAcc').value;
                var email = document.getElementById('gmailAcc').value;
                var password = document.getElementById('passAcc').value;
                var isValid = true;

                // Validate name
                if (name.length > 15) {
                    document.getElementById('nameAcc').style.border = 'red 1px solid';
                    document.getElementById('erorrMasge').innerText = 'Your Name is long Please write at most 14 characters.';
                    document.getElementById('erorrMasge').style.color = 'red';
                    isValid = false;
                } else {
                  document.getElementById('nameAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is good';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (name.length < 3) {
                  document.getElementById('nameAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is short Please write at least 4 characters.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('nameAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is good';
                  document.getElementById('erorrMasge').style.color = 'green';
                }

                // Validate email
                if (!email.endsWith('@gmail.com')) {
                  document.getElementById('gmailAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Email most ending with @gmail.com';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('gmailAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (email.length < 13) {
                  document.getElementById('gmailAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Email is short Please write 13 at all.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('gmailAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }

                // Validate password
                if (password.length < 8) {
                  document.getElementById('passAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your password is short Please write at least 8 characters.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('passAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (isValid) {
                  localStorage.setItem('nameSignup', name);
                  localStorage.setItem('emailSignup', email);
                  localStorage.setItem('passSignup', password);
                  document.getElementById('part1sinup').style.display = 'none';
                  document.getElementById('part2sinup').style.display = 'block';
                  document.getElementById('part3sinup').style.display = 'none';
                }
              ">Continue</button>
            </div>

            <div class="part2" id="part2sinup">
              <div class="phone1" style="display: flex; flex-direction: column;">
                <h2 style="margin-top: -20px;">Glasses Prescription</h2>
                <div style="display: flex; align-items: center; margin-top: -10px; margin-bottom: 5px;">
                  <label for="imageUpload" class="upload-btn">Upload Img</label>
                  <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                  <button class="upload-btn" onclick="openCamera('capture')">Capture</button>
                  <button class="upload-btn" onclick="startAutoScan()">Auto Scan</button>
                </div>
                <p id="loading" style="margin-left: 20px; display: none;">Processing image... <span id="progressPercent">0</span>%</p>
              </div>
              <p id="output" class="phone2" style="font-size: 90%;">Extracted text will appear here</p>
            
              <div class="eyeline-1">
                <div class="eyeblock1"><h4 class="aeyeText">AEYE</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Sphere</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Cylinder</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Axis</h4></div>
              </div>
              <div class="eyeline-2">
                <div class="eyeblock1"><h4 class="aeyeText">Right (OD)</h4></div>
                <div class="eyeblock3"><input id="odSp" type="text" class="inputeyefildes" placeholder="+2.50"></div>
                <div class="eyeblock3"><input id="odCy" type="text" class="inputeyefildes" placeholder="-1.50"></div>
                <div class="eyeblock3"><input id="odAx" type="text" class="inputeyefildes" placeholder="70"></div>
              </div>
              <div class="eyeline-3">
                <div class="eyeblock1"><h4 class="aeyeText">Left (OS)</h4></div>
                <div class="eyeblock3"><input id="osSp" type="text" class="inputeyefildes" placeholder="-2.50"></div>
                <div class="eyeblock3"><input id="osCy" type="text" class="inputeyefildes" placeholder="+3.50"></div>
                <div class="eyeblock3"><input id="osAx" type="text" class="inputeyefildes" placeholder="80"></div>
              </div>
              <progress id="progressBar" value="0" max="100" style="margin-left: 15%; width: 70%; margin-top: 0;"></progress>
              <p id="errorMessage" style="text-align: left; margin-bottom: 5px; margin-left: 17%; width: 70%; color: red; margin-top: 5px;">Please fill in all fields, and if you wanna skip, add all 0</p>
              <button class="sssggssddss login-button widthbut" onclick="validateAndContinue()">Continue</button>
            </div>
            
            <!-- Camera Modal -->
            <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center;">
              <div style="width: 90%; max-width: 500px; background: white; padding: 20px; border-radius: 10px;">
                <h2 id="modalTitle">Capture Prescription</h2>
                
                <!-- Camera Selection and Info -->
                <div id="cameraControls" style="margin-bottom: 10px;">
                  <div id="cameraInfo" style="padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px; display: none;">
                    <h4 style="margin-top: 0;">Available Cameras:</h4>
                    <div id="camerasList" style="max-height: 100px; overflow-y: auto;"></div>
                  </div>
                  
                  <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <button id="switchCameraBtn" class="camera-control-btn" style="display: none;">
                      <i class="fas fa-sync-alt"></i> Switch Camera
                    </button>
                    <button id="flashBtn" class="camera-control-btn" style="display: none;">
                      <i class="fas fa-bolt"></i> Flash OFF
                    </button>
                  </div>
                </div>
                
                <!-- Error Message Display -->
                <div id="cameraError" style="color: red; margin: 10px 0; display: none;"></div>
                
                <!-- Camera Feed -->
                <video id="cameraFeed" autoplay playsinline style="width: 100%; height: auto; background: black;"></video>
                <canvas id="photoCanvas" style="display: none;"></canvas>
                
                <!-- Action Buttons -->
                <div style="display: flex; justify-content: center; margin-top: 15px; gap: 10px;">
                  <button id="captureBtn" class="action-btn" style="background: #4CAF50; display: none;">
                    <i class="fas fa-camera"></i> Capture
                  </button>
                  <button onclick="closeCamera()" class="action-btn" style="background: #f44336;">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </div>
              </div>
            </div>

            <!-- Add Font Awesome for icons -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

            
            <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
            <script>
            // Global variables
            let stream = null;
            let isAutoScan = false;
            let autoScanTimeout = null;
            let currentMode = '';
            let flashEnabled = false;
            let currentCameraId = '';
            let cameras = [];
            let facingMode = 'environment'; // Default to rear camera

            // Initialize form with saved values
            window.addEventListener('DOMContentLoaded', () => {
                const fields = ['odSp', 'odCy', 'odAx', 'osSp', 'osCy', 'osAx'];
                fields.forEach(field => {
                    const savedValue = localStorage.getItem(field);
                    if (savedValue) {
                        document.getElementById(field).value = savedValue;
                    }
                });
                
                // Check for camera support
                checkCameraSupport();
            });

            // Check if browser supports camera access
            function checkCameraSupport() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showCameraError('Camera access not supported in this browser.');
                    return false;
                }
                return true;
            }

            // Get list of available cameras with details
            async function getAvailableCameras() {
                try {
                    // First request camera access to get full device info
                    await navigator.mediaDevices.getUserMedia({ video: true });
                    
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    cameras = devices.filter(device => device.kind === 'videoinput');
                    
                    const camerasList = document.getElementById('camerasList');
                    camerasList.innerHTML = '';
                    
                    if (cameras.length === 0) {
                        camerasList.innerHTML = '<p>No cameras found on this device.</p>';
                        return [];
                    }
                    
                    cameras.forEach((camera, index) => {
                        const cameraDiv = document.createElement('div');
                        cameraDiv.style.padding = '5px';
                        cameraDiv.style.borderBottom = '1px solid #ddd';
                        
                        // Try to determine camera type
                        let cameraType = 'Unknown';
                        if (camera.label.toLowerCase().includes('back') || camera.label.toLowerCase().includes('rear')) {
                            cameraType = 'Rear Camera';
                            facingMode = 'environment';
                        } else if (camera.label.toLowerCase().includes('front') || camera.label.toLowerCase().includes('face')) {
                            cameraType = 'Front Camera';
                            facingMode = 'user';
                        }
                        
                        cameraDiv.innerHTML = `
                            <strong>Camera ${index + 1}:</strong> ${camera.label || 'Unnamed Camera'}<br>
                            <small>Type: ${cameraType}</small>
                        `;
                        camerasList.appendChild(cameraDiv);
                    });
                    
                    document.getElementById('cameraInfo').style.display = 'block';
                    return cameras;
                } catch (err) {
                    console.error('Error enumerating cameras:', err);
                    showCameraError('Failed to access camera devices. Please ensure camera permissions are granted.');
                    return [];
                }
            }

            // Start camera with specific constraints
            async function startCamera(deviceId = null) {
                closeCurrentStream();
                
                const errorElement = document.getElementById('cameraError');
                errorElement.style.display = 'none';
                
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            ...(deviceId ? { deviceId: { exact: deviceId } } : { facingMode })
                        },
                        audio: false
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    const video = document.getElementById('cameraFeed');
                    video.srcObject = stream;
                    
                    // Get current camera ID
                    const videoTrack = stream.getVideoTracks()[0];
                    if (videoTrack) {
                        currentCameraId = videoTrack.getSettings().deviceId;
                    }
                    
                    // Show capture button
                    document.getElementById('captureBtn').style.display = 'inline-block';
                    
                    // Update camera controls
                    updateCameraControls();
                    
                    return true;
                } catch (err) {
                    console.error('Camera start error:', err);
                    let errorMsg = 'Could not access the camera.';
                    
                    if (err.name === 'NotAllowedError') {
                        errorMsg = 'Camera permission denied. Please allow camera access.';
                    } else if (err.name === 'NotFoundError') {
                        errorMsg = 'No camera found on this device.';
                    } else if (err.name === 'OverconstrainedError') {
                        errorMsg = 'Camera constraints could not be satisfied.';
                    }
                    
                    showCameraError(errorMsg);
                    return false;
                }
            }

            // Switch between front and back cameras
            async function switchCamera() {
                if (cameras.length < 2) {
                    showCameraError('Only one camera available on this device.');
                    return;
                }
                
                // Toggle between front and back
                facingMode = facingMode === 'user' ? 'environment' : 'user';
                
                // Find a camera matching the new facing mode
                const newCamera = cameras.find(cam => {
                    const label = cam.label.toLowerCase();
                    return (facingMode === 'environment' && (label.includes('back') || label.includes('rear'))) ||
                          (facingMode === 'user' && (label.includes('front') || label.includes('face')));
                });
                
                if (newCamera) {
                    await startCamera(newCamera.deviceId);
                } else {
                    // Fallback to default behavior if no matching camera found
                    await startCamera();
                }
            }

            // Toggle flash on/off
            async function toggleFlash() {
                if (!stream) return;
                
                try {
                    const videoTrack = stream.getVideoTracks()[0];
                    if (!videoTrack) return;
                    
                    const capabilities = videoTrack.getCapabilities();
                    if (!capabilities.torch) {
                        showCameraError('Flash not supported on this camera.');
                        return;
                    }
                    
                    flashEnabled = !flashEnabled;
                    await videoTrack.applyConstraints({
                        advanced: [{ torch: flashEnabled }]
                    });
                    
                    const flashBtn = document.getElementById('flashBtn');
                    flashBtn.innerHTML = flashEnabled ? 
                        '<i class="fas fa-bolt"></i> Flash ON' : 
                        '<i class="fas fa-bolt"></i> Flash OFF';
                    
                    return true;
                } catch (err) {
                    console.error('Flash toggle error:', err);
                    showCameraError('Failed to toggle flash.');
                    return false;
                }
            }

            // Update camera control buttons based on capabilities
            function updateCameraControls() {
                if (!stream) return;
                
                const videoTrack = stream.getVideoTracks()[0];
                if (!videoTrack) return;
                
                // Show/hide switch button based on available cameras
                const switchBtn = document.getElementById('switchCameraBtn');
                switchBtn.style.display = cameras.length > 1 ? 'inline-block' : 'none';
                
                // Show/hide flash button based on capabilities
                const flashBtn = document.getElementById('flashBtn');
                const capabilities = videoTrack.getCapabilities();
                flashBtn.style.display = capabilities.torch ? 'inline-block' : 'none';
            }

            // Display camera error message
            function showCameraError(message) {
                const errorElement = document.getElementById('cameraError');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }

            // Close current camera stream
            function closeCurrentStream() {
                if (stream) {
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                    stream = null;
                }
            }

            // Open camera for capture or scan
            async function openCamera(mode) {
                if (!checkCameraSupport()) {
                    showCameraError('Camera access not supported in this browser.');
                    return;
                }
                
                currentMode = mode;
                isAutoScan = mode === 'scan';
                document.getElementById('modalTitle').textContent = 
                    mode === 'scan' ? 'Auto Scanning Prescription' : 'Capture Prescription';
                document.getElementById('cameraModal').style.display = 'flex';
                
                // Get available cameras
                await getAvailableCameras();
                
                // Start default camera
                const started = await startCamera();
                
                if (started) {
                    if (isAutoScan) {
                        document.getElementById('captureBtn').style.display = 'none';
                        autoScanTimeout = setTimeout(() => {
                            captureImage();
                        }, 3000);
                    } else {
                        document.getElementById('captureBtn').style.display = 'inline-block';
                    }
                    
                    // Set up control buttons
                    document.getElementById('switchCameraBtn').onclick = switchCamera;
                    document.getElementById('flashBtn').onclick = toggleFlash;
                    document.getElementById('captureBtn').onclick = captureImage;
                }
            }

            // Capture image from camera
            function captureImage() {
                const video = document.getElementById('cameraFeed');
                const canvas = document.getElementById('photoCanvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Enhance image before processing
                const imageData = enhancePrescriptionImage(canvas);
                
                closeCamera();
                performOCR(imageData);
            }

            // Close camera modal
            function closeCamera() {
                if (autoScanTimeout) {
                    clearTimeout(autoScanTimeout);
                    autoScanTimeout = null;
                }
                
                closeCurrentStream();
                document.getElementById('cameraModal').style.display = 'none';
            }

            // Enhance prescription image for better OCR results
            function enhancePrescriptionImage(canvas) {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Increase image size for better resolution
                tempCanvas.width = canvas.width * 1.5;
                tempCanvas.height = canvas.height * 1.5;
                
                tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                
                // Apply contrast filter
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
                
                // Adjust contrast and brightness
                const contrast = 1.5;
                const brightness = 10;
                
                for (let i = 0; i < data.length; i += 4) {
                    // Convert to grayscale
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    
                    // Apply contrast and brightness
                    const adjusted = (gray - 128) * contrast + 128 + brightness;
                    
                    // Set final values
                    data[i] = data[i + 1] = data[i + 2] = adjusted < 0 ? 0 : adjusted > 255 ? 255 : adjusted;
                    
                    // Increase edge sharpness
                    data[i] = data[i + 1] = data[i + 2] = data[i] > 180 ? 255 : data[i] < 50 ? 0 : data[i];
                }
                
                tempCtx.putImageData(imageData, 0, 0);
                return tempCanvas.toDataURL('image/jpeg', 0.9);
            }

            // Perform OCR on the captured image
            async function performOCR(imageData) {
                const loadingElement = document.getElementById('loading');
                const progressBar = document.getElementById('progressBar');
                const progressPercent = document.getElementById('progressPercent');
                const outputElement = document.getElementById('output');
                
                loadingElement.style.display = 'block';
                progressBar.value = 0;
                outputElement.textContent = 'Processing image...';
                
                try {
                    // Pre-process image for better OCR accuracy
                    const processedImage = await preprocessPrescriptionImage(imageData);
                    
                    const { data: { text, progress } } = await Tesseract.recognize(
                        processedImage,
                        'eng',
                        {
                            logger: m => {
                                progressBar.value = m.progress * 100;
                                progressPercent.textContent = Math.round(m.progress * 100);
                                if (m.status) outputElement.textContent = m.status;
                            },
                            tessedit_char_whitelist: '0123456789+-.ODOSRLEAXISPHCYLAXSPHEREYRIGHTLEFT',
                            preserve_interword_spaces: '1',
                            tessedit_pageseg_mode: '6'
                        }
                    );
                    
                    outputElement.textContent = text;
                    parsePrescription(text);
                } catch (error) {
                    console.error('Error in OCR:', error);
                    outputElement.textContent = 'Error processing image. Please try again or enter data manually.';
                } finally {
                    loadingElement.style.display = 'none';
                }
            }

            // Pre-process prescription image specifically for glasses prescriptions
            async function preprocessPrescriptionImage(imageData) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set new dimensions while maintaining aspect ratio
                        const maxWidth = 1000;
                        const maxHeight = 1000;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        
                        if (height > maxHeight) {
                            width = (maxHeight / height) * width;
                            height = maxHeight;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw image with contrast enhancement
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Improve image for text focus
                        const imageData = ctx.getImageData(0, 0, width, height);
                        const data = imageData.data;
                        
                        // Adjust contrast and brightness
                        const contrast = 1.5;
                        const brightness = 0;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            // Convert to grayscale
                            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                            
                            // Apply contrast and brightness
                            const adjusted = (gray - 128) * contrast + 128 + brightness;
                            
                            // Set final values
                            data[i] = data[i + 1] = data[i + 2] = adjusted < 0 ? 0 : adjusted > 255 ? 255 : adjusted;
                            
                            // Increase edge sharpness
                            data[i] = data[i + 1] = data[i + 2] = data[i] > 180 ? 255 : data[i] < 50 ? 0 : data[i];
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg'));
                    };
                    img.src = imageData;
                });
            }

            // Parse prescription text to extract values
            function parsePrescription(text) {
                // Clean and normalize text for parsing
                const normalizedText = text
                    .replace(/[^a-zA-Z0-9\+\-\.\s]/g, ' ') // Remove special characters
                    .replace(/\s+/g, ' ') // Normalize spaces
                    .toUpperCase();
                
                console.log("Normalized text:", normalizedText);

                // Custom patterns for glasses prescriptions
                const patterns = [
                    // Pattern 1: OD/OS with Sphere, Cylinder, Axis
                    /(?:OD|RIGHT|RE)[^:\n]*:\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+).*?(?:OS|LEFT|LE)[^:\n]*:\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+)/i,
                    
                    // Pattern 2: Sphere, Cylinder, Axis values for each eye
                    /(?:SPH|SPHERE)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:CYL|CYLINDER)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:AX|AXIS)[^\d\+-]*(\d+).*?(?:SPH|SPHERE)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:CYL|CYLINDER)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:AX|AXIS)[^\d\+-]*(\d+)/i,
                    
                    // Pattern 3: Values in order (OD then OS)
                    /([+-]?\d+\.?\d*)\s+([+-]?\d+\.?\d*)\s+(\d+)\s+([+-]?\d+\.?\d*)\s+([+-]?\d+\.?\d*)\s+(\d+)/i,
                    
                    // Pattern 4: With labels for each eye (without :)
                    /(?:OD|RIGHT|RE)\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+).*?(?:OS|LEFT|LE)\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+)/i
                ];

                let matches = null;
                for (const pattern of patterns) {
                    matches = normalizedText.match(pattern);
                    if (matches) break;
                }

                if (matches && matches.length >= 7) {
                    // Determine which eye comes first based on pattern
                    const isOdFirst = normalizedText.indexOf('OD') > -1 || 
                                    normalizedText.indexOf('RIGHT') > -1 || 
                                    normalizedText.indexOf('RE') > -1 ||
                                    (normalizedText.indexOf('OS') === -1 && 
                                    normalizedText.indexOf('LEFT') === -1 && 
                                    normalizedText.indexOf('LE') === -1);

                    if (isOdFirst) {
                        // Right eye first
                        document.getElementById('odSp').value = formatNumber(matches[1]);
                        document.getElementById('odCy').value = formatNumber(matches[2]);
                        document.getElementById('odAx').value = formatNumber(matches[3], true);
                        document.getElementById('osSp').value = formatNumber(matches[4]);
                        document.getElementById('osCy').value = formatNumber(matches[5]);
                        document.getElementById('osAx').value = formatNumber(matches[6], true);
                    } else {
                        // Left eye first
                        document.getElementById('osSp').value = formatNumber(matches[1]);
                        document.getElementById('osCy').value = formatNumber(matches[2]);
                        document.getElementById('osAx').value = formatNumber(matches[3], true);
                        document.getElementById('odSp').value = formatNumber(matches[4]);
                        document.getElementById('odCy').value = formatNumber(matches[5]);
                        document.getElementById('odAx').value = formatNumber(matches[6], true);
                    }
                    
                    console.log("Matched values:", matches.slice(1, 7));
                } else {
                    console.log("No matching pattern found");
                    // Fallback method: Find all numbers and assign in order
                    const numbers = normalizedText.match(/[+-]?\d+\.?\d*/g) || [];
                    if (numbers.length >= 6) {
                        document.getElementById('odSp').value = formatNumber(numbers[0]);
                        document.getElementById('odCy').value = formatNumber(numbers[1]);
                        document.getElementById('odAx').value = formatNumber(numbers[2], true);
                        document.getElementById('osSp').value = formatNumber(numbers[3]);
                        document.getElementById('osCy').value = formatNumber(numbers[4]);
                        document.getElementById('osAx').value = formatNumber(numbers[5], true);
                    } else {
                        alert("Could not extract prescription data. Please enter manually.");
                    }
                }
            }

            // Format numbers correctly for prescription values
            function formatNumber(value, isAxis = false) {
                if (!value) return '0';
                
                // Remove any non-numeric characters
                let numStr = value.toString().replace(/[^0-9+-.]/g, '');
                
                // Special handling for Axis
                if (isAxis) {
                    let axisNum = parseFloat(numStr.replace(/[^0-9]/g, ''));
                    axisNum = Math.max(0, Math.min(180, axisNum)); // Ensure axis is between 0-180
                    return axisNum.toString();
                }
                
                // Ensure +/- sign exists
                if (!['+', '-'].includes(numStr.charAt(0))) {
                    numStr = '+' + numStr;
                }
                
                // Ensure decimal places
                if (!numStr.includes('.')) {
                    numStr += '.00';
                } else if (numStr.split('.')[1].length < 2) {
                    numStr = numStr.padEnd(numStr.indexOf('.') + 3, '0');
                } else if (numStr.split('.')[1].length > 2) {
                    numStr = numStr.substring(0, numStr.indexOf('.') + 3);
                }
                
                return numStr;
            }

            // Handle image upload
            async function handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    await performOCR(e.target.result);
                };
                reader.readAsDataURL(file);
            }

            // Start auto scan
            function startAutoScan() {
                openCamera('scan');
            }

            // Validate form and continue
            function validateAndContinue() {
                const fields = [
                    { id: 'odSp', isAxis: false },
                    { id: 'odCy', isAxis: false },
                    { id: 'odAx', isAxis: true },
                    { id: 'osSp', isAxis: false },
                    { id: 'osCy', isAxis: false },
                    { id: 'osAx', isAxis: true }
                ];
                
                let hasInvalidField = false;
                
                fields.forEach(({ id, isAxis }) => {
                    const element = document.getElementById(id);
                    const value = element.value.trim();
                    
                    if (!isValidPrescriptionValue(value, isAxis)) {
                        element.style.border = '1px solid red';
                        hasInvalidField = true;
                    } else {
                        element.style.border = '';
                        localStorage.setItem(id, value);
                    }
                });
                
                const button = document.querySelector('.login-button');
                const errorMessage = document.getElementById('errorMessage');
                
                if (hasInvalidField) {
                    button.textContent = 'Skip (Set to 0)';
                    errorMessage.textContent = 'Invalid values detected. Please correct or click to set all to 0.';
                    errorMessage.style.color = 'red';
                    
                    button.onclick = function() {
                        fields.forEach(({ id }) => {
                            document.getElementById(id).value = '0';
                        });
                        validateAndContinue();
                    };
                } else {
                    button.textContent = 'Continue';
                    errorMessage.textContent = '';
                    
                    // Continue to next step
                    // document.getElementById('part1sinup').style.display = 'none';
                    // document.getElementById('part2sinup').style.display = 'none';
                    // document.getElementById('part3sinup').style.display = 'block';
                    
                    button.onclick = validateAndContinue;
                }
            }

            // Validate prescription values
            function isValidPrescriptionValue(value, isAxis) {
                if (value === '0') return true;
                
                if (isAxis) {
                    const num = parseInt(value, 10);
                    return !isNaN(num) && num >= 0 && num <= 180;
                } else {
                    const num = parseFloat(value);
                    return !isNaN(num) && num >= -30 && num <= 30 && 
                          /^[+-]?\d+(\.\d{1,2})?$/.test(value);
                }
            }
            </script>


            <div class="part3" id="part3sinup">
              <div class="input-laple editess">
                <p class="inp-text">Phone</p>
                <div class="input-div-style">
                  <input id="phoneAccc" type="text" class="input-style" placeholder="01120726090">
                  <img src="./image/singin/phone-receiver-silhouette.png" alt="" class="input-img">
                </div>
              </div>
              <div class="input-laple editess">
                <p class="inp-text">Address</p>
                <div class="input-div-style">
                  <textarea style="height: 100px; padding-right: 40px;" id="addressAccc" type="text" class="input-style" placeholder="Cairo-Badr - Downtown mall - Building 5 - Apartment 2"></textarea>
                  <img style="margin-top: 40px;" src="./image/singin/task-list.png" alt="" class="input-img">
                </div>
              </div>
              <p id="errorMessage2" style="margin-top: 80px; text-align: left; margin-bottom: 0px; margin-left: 26%; width: 50%;">Please fill in all fields</p>
              <button id="conbu" class="login-button widthbut" onclick="createACC()">Continue</button>
              <button id="createAcc" class="login-button widthbut" style="display: none;">Create Your Account</button>
              <script>
                  function createACC() {
                    var phone = document.getElementById('phoneAccc').value;
                    var address = document.getElementById('addressAccc').value;
                    var isValid = true;

                    // Validate phone
                    var phoneRegex = /^(011|012|015|010)\d{8}$/;
                    if (!phoneRegex.test(phone)) {
                        document.getElementById('phoneAccc').style.border = 'red 1px solid';
                        document.getElementById('errorMessage2').innerText = 'Your Phone is short Please write 11 characters. and It starts with 011, 012, 010, 015';
                        document.getElementById('errorMessage2').style.color = 'red';
                        isValid = false;
                    } else {
                      document.getElementById('phoneAccc').style.border = 'green 1px solid';
                      document.getElementById('errorMessage2').innerText = 'Your Name is good';
                      document.getElementById('errorMessage2').style.color = 'green';
                    }

                    // Validate address
                    if (address.length < 6) {
                        document.getElementById('addressAccc').style.border = 'red 1px solid';
                        document.getElementById('errorMessage2').innerText = 'Your Location is short Please write at least 6 characters.';
                        document.getElementById('errorMessage2').style.color = 'red';
                        isValid = false;
                    } else {
                      document.getElementById('addressAccc').style.border = 'green 1px solid';
                      document.getElementById('errorMessage2').innerText = 'Your Name is good';
                      document.getElementById('errorMessage2').style.color = 'green';
                    }

                    
                    if (isValid) {
                      localStorage.setItem('phoneSignup', phone);
                      localStorage.setItem('addressSignup', address);
                      document.getElementById('conbu').style.display = 'none';
                      document.getElementById('createAcc').style.display = 'block';
                    }
                  }
              </script>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      <!-- create -->

      <!-- login -->
      <div class="login" id="loginmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Login Your Account</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="loginemail" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Password</p>
                <div class="input-div-style">
                  <input id="loginpass" type="text" class="input-style">
                  <img src="./image/singin/key.png" alt="" class="input-img">
                </div>
              </div>
              <div class="remmber-div">
                <div class="forgetpass-div">
                  <a href="./forget.html" class="forget-h5 forget-h6">Forget Password</a>
                </div>
                <div class="remm-div">
                  <input type="checkbox" id="remember-me" style="margin-top: 14px;">
                  <h5 class="forget-h5" style="color: black; margin-top: 10px;" onclick="">Auto Remmber</h5>
                </div>
              </div>
              <button id="loginButton" class="login-button">Login</button>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      </div>
      <!-- login -->

      <!-- forget -->
      <div class="forget" id="forgetmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Forget Your Account Password</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="forgetemail" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
              <button id="forgetButton" class="login-button">Send Mail</button>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      </div>
      <!-- forget -->



      <div class="noneee" style="display: none;">
        <!-- login -->
       <div class="login">
        <h1>Login Page</h1>
        <form id="loginForm">
          <input type="email" id="email1" placeholder="Enter your email" required><br>
          <input type="password" id="password1" placeholder="Enter your password" required><br>
          <button type="button" id="">Login</button>
        </form>
        <h2>Stored Data:</h2>
        <div id="displayData"></div>
       </div>     
      <!-- login -->

      <!-- signup -->
      <h1>Sign Up</h1>
      <form id="signUpForm">
        <input type="text" id="name" placeholder="Enter your name" required><br>
        <input type="email" id="email" placeholder="Enter your email" required><br>
        <input type="password" id="password" placeholder="Enter your password" required><br>
        <input type="text" id="eyesight" placeholder="Enter your eyesight measurement" required><br>
        <input type="tel" id="phone" placeholder="Enter your phone number" required><br>
        <input type="text" id="address" placeholder="Enter your address" required><br>
        <button type="button" id="submitButton">Sign Up</button>
      </form>
      <!-- signup -->

      

      <h2>Forgot Password?</h2>
      <form id="forgotPasswordForm">
        <input type="email" id="forgotEmail" placeholder="Enter your email" required><br>
        <button type="button" id="resetPasswordButton">Send Password Reset Email</button>
      </form>
      </div>
</body>
</html>