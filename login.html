<html lang="en">  
</body>
</html>
<head>
  <title>A-EYE</title> <!-- web name -->
  <LInk rel="icon" href="./image/logos/logo-02.png" type="image/x-icon"> <!-- web icon -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>  <!-- onlin icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">  <!-- onlin icons -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css-files/body-html.css"> <!-- css file loc -->
  <link rel="stylesheet" href="./css-files/index-css/header.css"> <!-- css file loc -->
  <link rel="stylesheet" href="./css-files/login-css/login.css"> <!-- css file loc -->
  <script type="module" src="./js-filse/login-js/firebase-db.js"></script>
  <script type="module" src="./js-filse/login-js/loading.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pica/dist/pica.min.js"></script>
</head>
<body>
      <!-- header -->
      <div class="header" id="header">
        <div class="logo">
          <h5 class="header-logo-h5">AEYE</h5>
        </div>
        <div class="main-header">
          <a id="allglassesheader" href="index.html" class="aa">Home</a>
          <a id="loginheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#000';
            document.getElementById('createmain').style.display = 'none';

            document.getElementById('loginheader').style.color = '#790000';
            document.getElementById('loginmain').style.display = 'block';

            document.getElementById('forgetheader').style.color = '#000';
            document.getElementById('forgetmain').style.display = 'none';
          ">Login</a>
          <a id="createheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#790000';
            document.getElementById('createmain').style.display = 'block';
            
            document.getElementById('loginheader').style.color = '#000';
            document.getElementById('loginmain').style.display = 'none';
            
            document.getElementById('forgetheader').style.color = '#000';
            document.getElementById('forgetmain').style.display = 'none';
          ">Sigin up</a>
          <a id="forgetheader" href="#" class="aa" onclick="
            document.getElementById('createheader').style.color = '#000';
            document.getElementById('createmain').style.display = 'none';
            
            document.getElementById('loginheader').style.color = '#000';
            document.getElementById('loginmain').style.display = 'none';
            
            document.getElementById('forgetheader').style.color = '#790000';
            document.getElementById('forgetmain').style.display = 'block';
          ">Forget</a>
        </div>
        <div class="login-button-home">
          <div class="bage-center" onclick="window.location.href = './checkout.html';" style="margin-right: 10;">
            <img src="./image/icons/bag.png" alt="" class="header-cart" onclick="">
            <p class="quantity" id="cart-count">2</p>
          </div>
          <a href="orders.html">
            <img src="./image/icons/delivery-truck.png" alt="" class="img-header-login">
          </a>
          <a href="login.html" id="adduser">
            <img src="./image/icons/add-user.png" alt="" class="img-header-login">
            </a>
            <a href="account.html" id="user" style="display: none;">
              <img src="./image/icons/user.png" alt="" class="img-header-login">
            </a>
            <script>
              if (localStorage.getItem('loginmethod') === '555') {
                document.getElementById('adduser').style.display = 'none';
                document.getElementById('user').style.display = 'block';
              }
            </script>
        </div>
      </div>
      <!-- header -->

      <!-- create -->
       <div class="create" id="createmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Sign Up Your Account</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Name</p>
                <div class="input-div-style">
                  <input id="nameAcc" type="text" class="input-style">
                  <img src="./image/singin/user.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="gmailAcc" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Password</p>
                <div class="input-div-style">
                  <input id="passAcc" type="text" class="input-style">
                  <img src="./image/singin/key.png" alt="" class="input-img">
                </div>
              </div>
              <p id="erorrMasge" style="text-align: left; margin-bottom: 0px; margin-left: 10px; width: 50%;">Please fill in all fields</p>
              <button class="login-button" onclick="
                var name = document.getElementById('nameAcc').value;
                var email = document.getElementById('gmailAcc').value;
                var password = document.getElementById('passAcc').value;
                var isValid = true;

                // Validate name
                if (name.length > 15) {
                    document.getElementById('nameAcc').style.border = 'red 1px solid';
                    document.getElementById('erorrMasge').innerText = 'Your Name is long Please write at most 14 characters.';
                    document.getElementById('erorrMasge').style.color = 'red';
                    isValid = false;
                } else {
                  document.getElementById('nameAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is good';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (name.length < 3) {
                  document.getElementById('nameAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is short Please write at least 4 characters.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('nameAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is good';
                  document.getElementById('erorrMasge').style.color = 'green';
                }

                // Validate email
                if (!email.endsWith('@gmail.com')) {
                  document.getElementById('gmailAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Email most ending with @gmail.com';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('gmailAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (email.length < 13) {
                  document.getElementById('gmailAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Email is short Please write 13 at all.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('gmailAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }

                // Validate password
                if (password.length < 8) {
                  document.getElementById('passAcc').style.border = 'red 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your password is short Please write at least 8 characters.';
                  document.getElementById('erorrMasge').style.color = 'red';
                  isValid = false;
                } else {
                  document.getElementById('passAcc').style.border = 'green 1px solid';
                  document.getElementById('erorrMasge').innerText = 'Your Name is email';
                  document.getElementById('erorrMasge').style.color = 'green';
                }
                if (isValid) {
                  localStorage.setItem('nameSignup', name);
                  localStorage.setItem('emailSignup', email);
                  localStorage.setItem('passSignup', password);
                  document.getElementById('part1sinup').style.display = 'none';
                  document.getElementById('part2sinup').style.display = 'block';
                  document.getElementById('part3sinup').style.display = 'none';
                }
              ">Continue</button>
            </div>

            <div class="part2" id="part2sinup">
              <div class="phone1" style="display: flex; flex-direction: column;">
                <h2 style="margin-top: -20px;">Glasses Prescription</h2>
                <div style="display: flex; align-items: center; margin-top: -10px; margin-bottom: 5px;">
                  <label for="imageUpload" class="upload-btn">Upload Img</label>
                  <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                  <button class="upload-btn" onclick="openCamera('capture')">Capture</button>
                  <button class="upload-btn" onclick="startAutoScan()">Auto Scan</button>
                </div>
                <p id="loading" style="margin-left: 20px; display: none;">Processing image... <span id="progressPercent">0</span>%</p>
              </div>
              <p id="output" class="phone2" style="font-size: 90%;">Extracted text will appear here</p>
            
              <div class="eyeline-1">
                <div class="eyeblock1"><h4 class="aeyeText">AEYE</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Sphere</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Cylinder</h4></div>
                <div class="eyeblock2"><h4 class="aeyeText">Axis</h4></div>
              </div>
              <div class="eyeline-2">
                <div class="eyeblock1"><h4 class="aeyeText">Right (OD)</h4></div>
                <div class="eyeblock3"><input id="odSp" type="text" class="inputeyefildes" placeholder="+2.50"></div>
                <div class="eyeblock3"><input id="odCy" type="text" class="inputeyefildes" placeholder="-1.50"></div>
                <div class="eyeblock3"><input id="odAx" type="text" class="inputeyefildes" placeholder="70"></div>
              </div>
              <div class="eyeline-3">
                <div class="eyeblock1"><h4 class="aeyeText">Left (OS)</h4></div>
                <div class="eyeblock3"><input id="osSp" type="text" class="inputeyefildes" placeholder="-2.50"></div>
                <div class="eyeblock3"><input id="osCy" type="text" class="inputeyefildes" placeholder="+3.50"></div>
                <div class="eyeblock3"><input id="osAx" type="text" class="inputeyefildes" placeholder="80"></div>
              </div>
              <progress id="progressBar" value="0" max="100" style="margin-left: 15%; width: 70%; margin-top: 0;"></progress>
              <p id="errorMessage" style="text-align: left; margin-bottom: 5px; margin-left: 17%; width: 70%; color: red; margin-top: 5px;">Please fill in all fields, and if you wanna skip, add all 0</p>
              <button class="sssggssddss login-button widthbut" onclick="validateAndContinue()">Continue</button>
            </div>
            
            <!-- Camera Modal -->
            <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center;">
              <div style="width: 90%; max-width: 500px; background: white; padding: 20px; border-radius: 10px;">
                <h2 id="modalTitle">Capture Prescription</h2>
                
                <!-- إضافة قائمة اختيار الكاميرات -->
                <div id="cameraSelectContainer" style="margin-bottom: 10px; display: none;">
                  <label for="cameraSelect">Select Camera: </label>
                  <select id="cameraSelect" style="padding: 5px; border-radius: 4px;"></select>
                </div>
                
                <video id="cameraFeed" autoplay playsinline style="width: 100%; height: auto; background: black;"></video>
                <canvas id="photoCanvas" style="display: none;"></canvas>
                <div style="display: flex; justify-content: center; margin-top: 15px;">
                  <button id="captureBtn" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; margin: 0 10px;">Capture</button>
                  <button id="switchCameraBtn" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; margin: 0 10px;">Switch Camera</button>
                  <button id="flashBtn" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 5px; margin: 0 10px;">Flash OFF</button>
                  <button onclick="closeCamera()" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 5px; margin: 0 10px;">Cancel</button>
                </div>
              </div>
            </div>
            
            <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
            <script>
                // متغيرات عامة
                let stream = null;
                let isAutoScan = false;
                let autoScanTimeout = null;
                let currentMode = '';
                let flashEnabled = false;
                let currentCameraId = '';
                let cameras = [];
                
                // تهيئة النموذج بالقيم المحفوظة
                window.addEventListener('DOMContentLoaded', () => {
                    const fields = ['odSp', 'odCy', 'odAx', 'osSp', 'osCy', 'osAx'];
                    fields.forEach(field => {
                        const savedValue = localStorage.getItem(field);
                        if (savedValue) {
                            document.getElementById(field).value = savedValue;
                        }
                    });
                });
            
                // دالة للحصول على قائمة الكاميرات المتاحة
                async function getAvailableCameras() {
                    try {
                        // الحصول على أجهزة الوسائط
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        
                        // تصفية أجهزة الفيديو فقط
                        cameras = devices.filter(device => device.kind === 'videoinput');
                        
                        // إذا كان هناك أكثر من كاميرا، نعرض قائمة الاختيار
                        if (cameras.length > 1) {
                            const cameraSelect = document.getElementById('cameraSelect');
                            cameraSelect.innerHTML = '';
                            
                            cameras.forEach((camera, index) => {
                                const option = document.createElement('option');
                                option.value = camera.deviceId;
                                option.text = camera.label || `Camera ${index + 1}`;
                                cameraSelect.appendChild(option);
                            });
                            
                            document.getElementById('cameraSelectContainer').style.display = 'block';
                        } else {
                            document.getElementById('cameraSelectContainer').style.display = 'none';
                        }
                        
                        return cameras;
                    } catch (err) {
                        console.error('Error enumerating cameras:', err);
                        return [];
                    }
                }
                
                // دالة لتبديل الكاميرا
                async function switchCamera() {
                    if (cameras.length < 2) return;
                    
                    const cameraSelect = document.getElementById('cameraSelect');
                    const currentIndex = cameras.findIndex(cam => cam.deviceId === currentCameraId);
                    const nextIndex = (currentIndex + 1) % cameras.length;
                    const nextCameraId = cameras[nextIndex].deviceId;
                    
                    cameraSelect.value = nextCameraId;
                    await startCamera(nextCameraId);
                }
            
                // فتح الكاميرا مع تحديد الكاميرا المطلوبة
                async function startCamera(deviceId = '') {
                    // إيقاف الكاميرا الحالية إذا كانت تعمل
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    try {
                        const constraints = { 
                            video: { 
                                deviceId: deviceId ? { exact: deviceId } : undefined,
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                facingMode: deviceId ? undefined : 'environment'
                            }, 
                            audio: false 
                        };
                        
                        // تفعيل الفلاش إذا كان متاحاً ومفعل
                        if (flashEnabled && 'torch' in navigator.mediaDevices.getSupportedConstraints()) {
                            constraints.video.torch = true;
                        }
                        
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                        const video = document.getElementById('cameraFeed');
                        video.srcObject = stream;
                        
                        // حفظ معرف الكاميرا الحالية
                        const videoTrack = stream.getVideoTracks()[0];
                        if (videoTrack) {
                            currentCameraId = videoTrack.getSettings().deviceId;
                        }
                        
                        // تحديث زر الفلاش بناء على إمكانيات الكاميرا
                        updateFlashButton();
                        
                    } catch (err) {
                        console.error('Camera error:', err);
                        alert('Could not access camera. Please check permissions.');
                        closeCamera();
                    }
                }
            
                // تحديث حالة زر الفلاش
                function updateFlashButton() {
                    if (!stream) return;
                    
                    const videoTrack = stream.getVideoTracks()[0];
                    const flashBtn = document.getElementById('flashBtn');
                    
                    if (videoTrack && 'torch' in videoTrack.getCapabilities()) {
                        flashBtn.style.display = 'block';
                        flashBtn.textContent = flashEnabled ? 'Flash ON' : 'Flash OFF';
                    } else {
                        flashBtn.style.display = 'none';
                        flashEnabled = false;
                    }
                }
            
                // فتح الكاميرا للتقاط أو مسح
                async function openCamera(mode) {
                    currentMode = mode;
                    isAutoScan = mode === 'scan';
                    document.getElementById('modalTitle').textContent = mode === 'scan' ? 'Auto Scanning Prescription' : 'Capture Prescription';
                    document.getElementById('cameraModal').style.display = 'flex';
                    
                    // الحصول على الكاميرات المتاحة
                    await getAvailableCameras();
                    
                    // بدء الكاميرا
                    await startCamera();
                    
                    // إعداد الأزرار
                    if (isAutoScan) {
                        document.getElementById('captureBtn').style.display = 'none';
                        autoScanTimeout = setTimeout(() => {
                            captureImage();
                        }, 3000); // تأخير 3 ثواني للمسح التلقائي
                    } else {
                        document.getElementById('captureBtn').style.display = 'block';
                        document.getElementById('captureBtn').onclick = captureImage;
                    }
                    
                    // إعداد زر تبديل الكاميرا
                    document.getElementById('switchCameraBtn').onclick = switchCamera;
                    
                    // إعداد زر الفلاش
                    document.getElementById('flashBtn').onclick = toggleFlash;
                    
                    // إعداد اختيار الكاميرا من القائمة
                    document.getElementById('cameraSelect').onchange = async function() {
                        await startCamera(this.value);
                    };
                }
            
                // تفعيل/إيقاف الفلاش
                async function toggleFlash() {
                    if (!stream) return;
                    
                    try {
                        const videoTrack = stream.getVideoTracks()[0];
                        if (videoTrack && 'torch' in videoTrack.getCapabilities()) {
                            flashEnabled = !flashEnabled;
                            await videoTrack.applyConstraints({
                                advanced: [{torch: flashEnabled}]
                            });
                            document.getElementById('flashBtn').textContent = flashEnabled ? 'Flash ON' : 'Flash OFF';
                            return true;
                        }
                    } catch (err) {
                        console.error('Flash error:', err);
                    }
                    return false;
                }
            
                // بقية الدوال كما هي (performOCR, preprocessPrescriptionImage, parsePrescription, formatNumber, 
                // handleImageUpload, startAutoScan, captureImage, enhancePrescriptionImage, closeCamera,
                // validateAndContinue, isValidPrescriptionValue)

                // تحسين دقة استخراج النص لمقاسات النظارات فقط
                async function performOCR(imageData) {
                    const loadingElement = document.getElementById('loading');
                    const progressBar = document.getElementById('progressBar');
                    const progressPercent = document.getElementById('progressPercent');
                    const outputElement = document.getElementById('output');
                    
                    loadingElement.style.display = 'block';
                    progressBar.value = 0;
                    outputElement.textContent = 'Processing image...';
                    
                    try {
                        // معالجة مسبقة للصورة لتحسين دقة OCR
                        const processedImage = await preprocessPrescriptionImage(imageData);
                        
                        const { data: { text, progress } } = await Tesseract.recognize(
                            processedImage,
                            'eng',
                            {
                                logger: m => {
                                    progressBar.value = m.progress * 100;
                                    progressPercent.textContent = Math.round(m.progress * 100);
                                    if (m.status) outputElement.textContent = m.status;
                                },
                                tessedit_char_whitelist: '0123456789+-.ODOSRLEAXISPHCYLAXSPHEREYRIGHTLEFT',
                                preserve_interword_spaces: '1',
                                tessedit_pageseg_mode: '6'
                            }
                        );
                        
                        outputElement.textContent = text;
                        parsePrescription(text);
                    } catch (error) {
                        console.error('Error in OCR:', error);
                        outputElement.textContent = 'Error processing image. Please try again or enter data manually.';
                    } finally {
                        loadingElement.style.display = 'none';
                    }
                }

                // معالجة مخصصة لصور وصفات النظارات
                async function preprocessPrescriptionImage(imageData) {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // تحديد أبعاد جديدة للصورة مع الحفاظ على التناسب
                            const maxWidth = 1000;
                            const maxHeight = 1000;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height = (maxWidth / width) * height;
                                width = maxWidth;
                            }
                            
                            if (height > maxHeight) {
                                width = (maxHeight / height) * width;
                                height = maxHeight;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // رسم الصورة مع تحسين التباين
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // تحسين الصورة للتركيز على النص
                            const imageData = ctx.getImageData(0, 0, width, height);
                            const data = imageData.data;
                            
                            // تحسين التباين والسطوع
                            const contrast = 1.5; // زيادة التباين
                            const brightness = 0; // تعديل السطوع
                            
                            for (let i = 0; i < data.length; i += 4) {
                                // تحويل إلى تدرج رمادي
                                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                                
                                // تطبيق التباين والسطوع
                                const adjusted = (gray - 128) * contrast + 128 + brightness;
                                
                                // تعيين القيم النهائية
                                data[i] = data[i + 1] = data[i + 2] = adjusted < 0 ? 0 : adjusted > 255 ? 255 : adjusted;
                                
                                // زيادة حدة الحواف (اختياري)
                                data[i] = data[i + 1] = data[i + 2] = data[i] > 180 ? 255 : data[i] < 50 ? 0 : data[i];
                            }
                            
                            ctx.putImageData(imageData, 0, 0);
                            
                            // اقتصاص المناطق غير الضرورية (اختياري)
                            // يمكن إضافة منطق لاقتصاص الصورة تلقائياً هنا
                            
                            resolve(canvas.toDataURL('image/jpeg'));
                        };
                        img.src = imageData;
                    });
                }

                // تحليل نص القياسات الطبية بدقة أعلى
                function parsePrescription(text) {
                    // تنظيف النص وتحسينه للتحليل
                    const normalizedText = text
                        .replace(/[^a-zA-Z0-9\+\-\.\s]/g, ' ') // إزالة الأحرف الخاصة
                        .replace(/\s+/g, ' ') // ضبط المسافات
                        .toUpperCase();
                    
                    console.log("Normalized text:", normalizedText);

                    // أنماط مخصصة لمقاسات النظارات فقط
                    const patterns = [
                        // النمط 1: OD/OS مع Sphere, Cylinder, Axis
                        /(?:OD|RIGHT|RE)[^:\n]*:\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+).*?(?:OS|LEFT|LE)[^:\n]*:\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+)/i,
                        
                        // النمط 2: قيم Sphere, Cylinder, Axis لكل عين
                        /(?:SPH|SPHERE)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:CYL|CYLINDER)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:AX|AXIS)[^\d\+-]*(\d+).*?(?:SPH|SPHERE)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:CYL|CYLINDER)[^\d\+-]*([+-]?\d+\.?\d*)[^\d\+-]*(?:AX|AXIS)[^\d\+-]*(\d+)/i,
                        
                        // النمط 3: قيم بالترتيب (OD ثم OS)
                        /([+-]?\d+\.?\d*)\s+([+-]?\d+\.?\d*)\s+(\d+)\s+([+-]?\d+\.?\d*)\s+([+-]?\d+\.?\d*)\s+(\d+)/i,
                        
                        // النمط 4: مع تسميات لكل عين (بدون :)
                        /(?:OD|RIGHT|RE)\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+).*?(?:OS|LEFT|LE)\s*([+-]?\d+\.?\d*)\s*([+-]?\d+\.?\d*)\s*(\d+)/i
                    ];

                    let matches = null;
                    for (const pattern of patterns) {
                        matches = normalizedText.match(pattern);
                        if (matches) break;
                    }

                    if (matches && matches.length >= 7) {
                        // تحديد أي العينين أولاً بناء على النمط
                        const isOdFirst = normalizedText.indexOf('OD') > -1 || 
                                        normalizedText.indexOf('RIGHT') > -1 || 
                                        normalizedText.indexOf('RE') > -1 ||
                                        (normalizedText.indexOf('OS') === -1 && 
                                        normalizedText.indexOf('LEFT') === -1 && 
                                        normalizedText.indexOf('LE') === -1);

                        if (isOdFirst) {
                            // العين اليمنى أولاً
                            document.getElementById('odSp').value = formatNumber(matches[1]);
                            document.getElementById('odCy').value = formatNumber(matches[2]);
                            document.getElementById('odAx').value = formatNumber(matches[3], true);
                            document.getElementById('osSp').value = formatNumber(matches[4]);
                            document.getElementById('osCy').value = formatNumber(matches[5]);
                            document.getElementById('osAx').value = formatNumber(matches[6], true);
                        } else {
                            // العين اليسرى أولاً
                            document.getElementById('osSp').value = formatNumber(matches[1]);
                            document.getElementById('osCy').value = formatNumber(matches[2]);
                            document.getElementById('osAx').value = formatNumber(matches[3], true);
                            document.getElementById('odSp').value = formatNumber(matches[4]);
                            document.getElementById('odCy').value = formatNumber(matches[5]);
                            document.getElementById('odAx').value = formatNumber(matches[6], true);
                        }
                        
                        console.log("Matched values:", matches.slice(1, 7));
                    } else {
                        console.log("No matching pattern found");
                        // طريقة احتياطية: البحث عن جميع الأرقام وتعيينها بالترتيب
                        const numbers = normalizedText.match(/[+-]?\d+\.?\d*/g) || [];
                        if (numbers.length >= 6) {
                            document.getElementById('odSp').value = formatNumber(numbers[0]);
                            document.getElementById('odCy').value = formatNumber(numbers[1]);
                            document.getElementById('odAx').value = formatNumber(numbers[2], true);
                            document.getElementById('osSp').value = formatNumber(numbers[3]);
                            document.getElementById('osCy').value = formatNumber(numbers[4]);
                            document.getElementById('osAx').value = formatNumber(numbers[5], true);
                        } else {
                            alert("Could not extract prescription data. Please enter manually.");
                        }
                    }
                }

                // تنسيق الأرقام بشكل صحيح لمقاسات النظارات
                function formatNumber(value, isAxis = false) {
                    if (!value) return '0';
                    
                    // إزالة أي أحرف غير رقمية
                    let numStr = value.toString().replace(/[^0-9+-.]/g, '');
                    
                    // معالجة خاصة لمحور Axis
                    if (isAxis) {
                        let axisNum = parseFloat(numStr.replace(/[^0-9]/g, ''));
                        axisNum = Math.max(0, Math.min(180, axisNum)); // التأكد من أن المحور بين 0 و180
                        return axisNum.toString();
                    }
                    
                    // التأكد من وجود علامة + أو -
                    if (!['+', '-'].includes(numStr.charAt(0))) {
                        numStr = '+' + numStr;
                    }
                    
                    // التأكد من وجود منزلة عشرية
                    if (!numStr.includes('.')) {
                        numStr += '.00';
                    } else if (numStr.split('.')[1].length < 2) {
                        numStr = numStr.padEnd(numStr.indexOf('.') + 3, '0');
                    } else if (numStr.split('.')[1].length > 2) {
                        numStr = numStr.substring(0, numStr.indexOf('.') + 3);
                    }
                    
                    return numStr;
                }

                // رفع الصورة ومعالجتها
                async function handleImageUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        await performOCR(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }

                // فتح الكاميرا للتقاط أو مسح
                async function openCamera(mode) {
                    currentMode = mode;
                    isAutoScan = mode === 'scan';
                    document.getElementById('modalTitle').textContent = mode === 'scan' ? 'Auto Scanning Prescription' : 'Capture Prescription';
                    document.getElementById('cameraModal').style.display = 'flex';
                    
                    try {
                        const constraints = { 
                            video: { 
                                facingMode: 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }, 
                            audio: false 
                        };
                        
                        // تفعيل الفلاش إذا كان متاحاً ومفعل
                        if (flashEnabled && 'torch' in navigator.mediaDevices.getSupportedConstraints()) {
                            constraints.video.torch = true;
                        }
                        
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                        const video = document.getElementById('cameraFeed');
                        video.srcObject = stream;
                        
                        if (isAutoScan) {
                            document.getElementById('captureBtn').style.display = 'none';
                            autoScanTimeout = setTimeout(() => {
                                captureImage();
                            }, 3000); // تأخير 3 ثواني للمسح التلقائي
                        } else {
                            document.getElementById('captureBtn').style.display = 'block';
                            document.getElementById('captureBtn').onclick = captureImage;
                        }
                    } catch (err) {
                        console.error('Camera error:', err);
                        alert('Could not access camera. Please check permissions.');
                        closeCamera();
                    }
                }

                // تفعيل/إيقاف الفلاش
                async function toggleFlash() {
                    if (!stream) return;
                    
                    try {
                        const videoTrack = stream.getVideoTracks()[0];
                        if (videoTrack && 'torch' in videoTrack.getCapabilities()) {
                            flashEnabled = !flashEnabled;
                            await videoTrack.applyConstraints({
                                advanced: [{torch: flashEnabled}]
                            });
                            document.getElementById('flashBtn').textContent = flashEnabled ? 'Flash ON' : 'Flash OFF';
                            return true;
                        }
                    } catch (err) {
                        console.error('Flash error:', err);
                    }
                    return false;
                }

                // بدء المسح التلقائي
                function startAutoScan() {
                    openCamera('scan');
                }

                // التقاط صورة من الكاميرا
                function captureImage() {
                    const video = document.getElementById('cameraFeed');
                    const canvas = document.getElementById('photoCanvas');
                    const context = canvas.getContext('2d');
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // تحسين الصورة قبل الحفظ
                    const imageData = enhancePrescriptionImage(canvas);
                    
                    // إغلاق الكاميرا ومعالجة الصورة
                    closeCamera();
                    performOCR(imageData);
                }

                // تحسين جودة الصورة لمقاسات النظارات
                function enhancePrescriptionImage(canvas) {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // زيادة حجم الصورة لتحسين الدقة
                    tempCanvas.width = canvas.width * 1.5;
                    tempCanvas.height = canvas.height * 1.5;
                    
                    tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // تطبيق مرشح لتحسين التباين
                    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    const data = imageData.data;
                    
                    // تحسين التباين والسطوع
                    const contrast = 1.5;
                    const brightness = 10;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        // تحويل إلى تدرج رمادي
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        
                        // تطبيق التباين والسطوع
                        const adjusted = (gray - 128) * contrast + 128 + brightness;
                        
                        // تعيين القيم النهائية
                        data[i] = data[i + 1] = data[i + 2] = adjusted < 0 ? 0 : adjusted > 255 ? 255 : adjusted;
                        
                        // زيادة حدة الحواف
                        data[i] = data[i + 1] = data[i + 2] = data[i] > 180 ? 255 : data[i] < 50 ? 0 : data[i];
                    }
                    
                    tempCtx.putImageData(imageData, 0, 0);
                    return tempCanvas.toDataURL('image/jpeg', 0.9);
                }

                // إغلاق الكاميرا وتنظيف الموارد
                function closeCamera() {
                    if (autoScanTimeout) {
                        clearTimeout(autoScanTimeout);
                        autoScanTimeout = null;
                    }
                    
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    
                    document.getElementById('cameraModal').style.display = 'none';
                }

                // التحقق من البيانات والمتابعة
                function validateAndContinue() {
                    const fields = [
                        { id: 'odSp', isAxis: false },
                        { id: 'odCy', isAxis: false },
                        { id: 'odAx', isAxis: true },
                        { id: 'osSp', isAxis: false },
                        { id: 'osCy', isAxis: false },
                        { id: 'osAx', isAxis: true }
                    ];
                    
                    let hasInvalidField = false;
                    
                    fields.forEach(({ id, isAxis }) => {
                        const element = document.getElementById(id);
                        const value = element.value.trim();
                        
                        if (!isValidPrescriptionValue(value, isAxis)) {
                            element.style.border = '1px solid red';
                            hasInvalidField = true;
                        } else {
                            element.style.border = '';
                            localStorage.setItem(id, value);
                        }
                    });
                    
                    const button = document.querySelector('.login-button');
                    const errorMessage = document.getElementById('errorMessage');
                    
                    if (hasInvalidField) {
                        button.textContent = 'Skip (Set to 0)';
                        errorMessage.textContent = 'Invalid values detected. Please correct or click to set all to 0.';
                        errorMessage.style.color = 'red';
                        
                        button.onclick = function() {
                            fields.forEach(({ id }) => {
                                document.getElementById(id).value = '0';
                            });
                            validateAndContinue();
                        };
                    } else {
                        button.textContent = 'Continue';
                        errorMessage.textContent = '';
                        
                        // المتابعة إلى الخطوة التالية
                        // document.getElementById('part1sinup').style.display = 'none';
                        // document.getElementById('part2sinup').style.display = 'none';
                        // document.getElementById('part3sinup').style.display = 'block';
                        
                        button.onclick = validateAndContinue;
                    }
                }
                
                // التحقق من صحة قيم وصفة النظارات
                function isValidPrescriptionValue(value, isAxis) {
                    if (value === '0') return true;
                    
                    if (isAxis) {
                        const num = parseInt(value, 10);
                        return !isNaN(num) && num >= 0 && num <= 180;
                    } else {
                        const num = parseFloat(value);
                        return !isNaN(num) && num >= -30 && num <= 30 && 
                              /^[+-]?\d+(\.\d{1,2})?$/.test(value);
                    }
                }
            </script>


            <div class="part3" id="part3sinup">
              <div class="input-laple editess">
                <p class="inp-text">Phone</p>
                <div class="input-div-style">
                  <input id="phoneAccc" type="text" class="input-style" placeholder="01120726090">
                  <img src="./image/singin/phone-receiver-silhouette.png" alt="" class="input-img">
                </div>
              </div>
              <div class="input-laple editess">
                <p class="inp-text">Address</p>
                <div class="input-div-style">
                  <textarea style="height: 100px; padding-right: 40px;" id="addressAccc" type="text" class="input-style" placeholder="Cairo-Badr - Downtown mall - Building 5 - Apartment 2"></textarea>
                  <img style="margin-top: 40px;" src="./image/singin/task-list.png" alt="" class="input-img">
                </div>
              </div>
              <p id="errorMessage2" style="margin-top: 80px; text-align: left; margin-bottom: 0px; margin-left: 26%; width: 50%;">Please fill in all fields</p>
              <button id="conbu" class="login-button widthbut" onclick="createACC()">Continue</button>
              <button id="createAcc" class="login-button widthbut" style="display: none;">Create Your Account</button>
              <script>
                  function createACC() {
                    var phone = document.getElementById('phoneAccc').value;
                    var address = document.getElementById('addressAccc').value;
                    var isValid = true;

                    // Validate phone
                    var phoneRegex = /^(011|012|015|010)\d{8}$/;
                    if (!phoneRegex.test(phone)) {
                        document.getElementById('phoneAccc').style.border = 'red 1px solid';
                        document.getElementById('errorMessage2').innerText = 'Your Phone is short Please write 11 characters. and It starts with 011, 012, 010, 015';
                        document.getElementById('errorMessage2').style.color = 'red';
                        isValid = false;
                    } else {
                      document.getElementById('phoneAccc').style.border = 'green 1px solid';
                      document.getElementById('errorMessage2').innerText = 'Your Name is good';
                      document.getElementById('errorMessage2').style.color = 'green';
                    }

                    // Validate address
                    if (address.length < 6) {
                        document.getElementById('addressAccc').style.border = 'red 1px solid';
                        document.getElementById('errorMessage2').innerText = 'Your Location is short Please write at least 6 characters.';
                        document.getElementById('errorMessage2').style.color = 'red';
                        isValid = false;
                    } else {
                      document.getElementById('addressAccc').style.border = 'green 1px solid';
                      document.getElementById('errorMessage2').innerText = 'Your Name is good';
                      document.getElementById('errorMessage2').style.color = 'green';
                    }

                    
                    if (isValid) {
                      localStorage.setItem('phoneSignup', phone);
                      localStorage.setItem('addressSignup', address);
                      document.getElementById('conbu').style.display = 'none';
                      document.getElementById('createAcc').style.display = 'block';
                    }
                  }
              </script>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      <!-- create -->

      <!-- login -->
      <div class="login" id="loginmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Login Your Account</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="loginemail" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
  
              <div class="input-laple">
                <p class="inp-text">Password</p>
                <div class="input-div-style">
                  <input id="loginpass" type="text" class="input-style">
                  <img src="./image/singin/key.png" alt="" class="input-img">
                </div>
              </div>
              <div class="remmber-div">
                <div class="forgetpass-div">
                  <a href="./forget.html" class="forget-h5 forget-h6">Forget Password</a>
                </div>
                <div class="remm-div">
                  <input type="checkbox" id="remember-me" style="margin-top: 14px;">
                  <h5 class="forget-h5" style="color: black; margin-top: 10px;" onclick="">Auto Remmber</h5>
                </div>
              </div>
              <button id="loginButton" class="login-button">Login</button>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      </div>
      <!-- login -->

      <!-- forget -->
      <div class="forget" id="forgetmain">
        <div class="continar">
          <div class="left">
            <div class="header-mian">
              <div class="welcome-massge">
                <h1>Welcome to&nbsp;<h1 class="aeye-word">AEYE</h1></h1>
              </div>
              <h3 class="main-sign-word">Forget Your Account Password</h3>
            </div>
            <br>
            <div class="part-1" id="part1sinup">
              <div class="input-laple">
                <p class="inp-text">Email</p>
                <div class="input-div-style">
                  <input id="forgetemail" type="email" class="input-style">
                  <img src="./image/singin/mail.png" alt="" class="input-img">
                </div>
              </div>
              <button id="forgetButton" class="login-button">Send Mail</button>
            </div>
          </div>
          

          <div class="right" >
            <div class="right-contant">*
              <h2>Customize Your EyeGlass</h2>
            </div>
            <div class="right-contant">*
              <h2>Trendy Glasses For All Ages</h2>
            </div>
            <div class="right-contant">*
              <h2>Up to 70% off on
                sunglasses</h2>
            </div>
          </div>
        </div>
       </div>
      </div>
      <!-- forget -->



      <div class="noneee" style="display: none;">
        <!-- login -->
       <div class="login">
        <h1>Login Page</h1>
        <form id="loginForm">
          <input type="email" id="email1" placeholder="Enter your email" required><br>
          <input type="password" id="password1" placeholder="Enter your password" required><br>
          <button type="button" id="">Login</button>
        </form>
        <h2>Stored Data:</h2>
        <div id="displayData"></div>
       </div>     
      <!-- login -->

      <!-- signup -->
      <h1>Sign Up</h1>
      <form id="signUpForm">
        <input type="text" id="name" placeholder="Enter your name" required><br>
        <input type="email" id="email" placeholder="Enter your email" required><br>
        <input type="password" id="password" placeholder="Enter your password" required><br>
        <input type="text" id="eyesight" placeholder="Enter your eyesight measurement" required><br>
        <input type="tel" id="phone" placeholder="Enter your phone number" required><br>
        <input type="text" id="address" placeholder="Enter your address" required><br>
        <button type="button" id="submitButton">Sign Up</button>
      </form>
      <!-- signup -->

      

      <h2>Forgot Password?</h2>
      <form id="forgotPasswordForm">
        <input type="email" id="forgotEmail" placeholder="Enter your email" required><br>
        <button type="button" id="resetPasswordButton">Send Password Reset Email</button>
      </form>
      </div>
</body>
</html>